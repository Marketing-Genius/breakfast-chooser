<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  --wallpaper:url('');              /* set at runtime */
  --wallpaper-shift: 40%;           /* upward crop focus */
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#0f172a; overflow-x:hidden;
}

/* Wallpaper layer */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper);
  background-size: cover; background-repeat:no-repeat;
  background-position: center var(--wallpaper-shift);
  transform: translateZ(0);
}
/* Veil + bottom gradient (heavier focus on cards) */
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  background:
    linear-gradient(180deg, rgba(15,23,42,0) 55%, rgba(15,23,42,.75) 80%, rgba(15,23,42,.95) 100%),
    rgba(15,23,42,.90);   /* 90% veil */
  pointer-events:none;
}

/* App layout: header at top, tiles+footer bottom-justified */
.app{
  min-height: 100svh;
  display: flex; flex-direction: column; gap: 18px;
  padding: 20px; padding-bottom: 20px;
  max-width:1100px; margin:0 auto;
}

/* Header (translucent & above tiles) */
header{
  position:relative; z-index: 9000; isolation:isolate;
  display:flex;justify-content:space-between;align-items:center;
  background:rgba(17,24,39,.5); border:1px solid rgba(11,18,36,.3);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
  backdrop-filter: blur(8px);
}
.title{display:flex;align-items:center;gap:10px}
.title img{height:38px;display:block}
.menu-wrap{position:relative; z-index: 9001; overflow:visible}
.hamburger{font:inherit;cursor:pointer;background:rgba(11,18,36,.6);color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:10px 12px}
.menu-dropdown{
  position:absolute;right:0;top:110%;min-width:260px;z-index:9002 !important;
  background:#111827;border:1px solid #1f2937;border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);padding:6px;display:none
}
.menu-dropdown.open{display:block}
.menu-item{width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:#e5e7eb;border-radius:10px;cursor:pointer}
.menu-item:hover{background:#0b1224}

/* Grid & tiles */
main.grid{ margin-top:auto; }
.grid{
  display:grid; gap:16px;
  grid-template-columns:repeat(2,minmax(0,1fr));
}
@media(min-width:900px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
.tile, .slot{
  background:rgba(31,41,55,.85); border:1px solid rgba(31,41,55,.9);
  border-radius:16px; box-shadow:var(--shadow); backdrop-filter: blur(4px);
  position:relative; z-index:1; min-height:120px;
}
.tile{
  display:flex;flex-direction:column;gap:10px;align-items:flex-start;padding:16px;text-decoration:none;color:var(--text);
  transition:transform .12s ease, outline-color .12s ease;
}
.tile .emoji{font-size:36px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
.tile .label{font-weight:800}
.tile .hint{opacity:.8}
.tile.disabled{opacity:.5;pointer-events:none}

.slot{
  display:grid; place-items:center; padding:12px; border-style:dashed; border-color:#334155; background:rgba(17,24,39,.6);
  color:#9ca3af; user-select:none;
}
.slot .plus{
  width:56px;height:56px;border-radius:999px;border:1px solid #334155;background:#0b1224;display:grid;place-items:center;font-size:26px;cursor:pointer;
}
.slot:hover{border-color:#4b5563}

/* Edit affordances */
.app.editing .tile{ cursor:pointer; outline:2px solid transparent; }
.app.editing .tile.selected{ outline:2px solid var(--accent); }
.app.editing .tile .remove{
  position:absolute; right:10px; bottom:10px;
  width:32px;height:32px;border-radius:999px;display:grid;place-items:center;
  background:#be123c; color:#fff; font-weight:800; border:1px solid #7f1d1d; cursor:pointer;
}

/* Editing bar */
.editbar{
  position:sticky; bottom:0; z-index:8000;
  display:none; justify-content:flex-end; gap:10px;
  padding:10px; margin-top:6px;
}
.app.editing .editbar{ display:flex; }

/* Buttons & UI bits (shared) */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.btn{font:inherit;color:#e5e7eb;background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px 12px;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#001018;border:none;font-weight:800}
.btn-ghost{background:transparent;border:1px dashed #334155;color:var(--muted)}
.btn-lg{padding:12px 16px;border-radius:14px;font-weight:800}
.btn-warn{background:#3f1620;border:1px solid #7f1d1d;color:#fecaca}

/* Modal (Admin & Add Card share same skin) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);background:rgba(17,24,39,.98);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937}
.modal .body{padding:14px 16px;display:grid;gap:18px}
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px}

/* Admin specific bits (unchanged) */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;background:#0b1224;border:1px solid #334155;cursor:pointer}
.tab[aria-selected="true"]{outline:2px solid var(--accent)}
.list{display:grid; gap:12px;}
.item{display:flex;align-items:center;gap:10px;background:#1f2937;border:1px solid #111827;border-radius:12px;padding:12px}
.item .grow{flex:1}
.face{width:48px;height:48px;border-radius:50%;background:#0b1224;display:grid;place-items:center;font-size:22px;border:2px solid #334155;overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0;}
.toggle{display:inline-flex;align-items:center;gap:8px}

/* Footer */
footer{
  align-self:end;
  text-align:center;
  font-size:.75rem;
  color:#38bdf8;
  opacity:.7;
}
footer .version{opacity:.6;font-size:.7rem}
</style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <div class="title">
        <img src="fambam.png" alt="Fambam">
      </div>
      <div class="menu-wrap">
        <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">☰</button>
        <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
          <button class="menu-item" data-action="edithome" role="menuitem">Edit Home</button>
          <div style="height:6px"></div>
          <button class="menu-item" data-action="admin" role="menuitem">Admin Settings</button>
          <button class="menu-item" data-action="wallpaper" role="menuitem">Edit Wallpaper</button>
          <button class="menu-item" data-action="clearwp" role="menuitem">Clear Wallpaper</button>
          <div style="height:6px"></div>
          <button class="menu-item" data-action="about" role="menuitem">About</button>
        </div>
      </div>
    </header>

    <!-- Rendered grid goes here -->
    <main id="grid" class="grid" aria-label="App sections"></main>

    <!-- Editing bar -->
    <div class="editbar">
      <button id="btnDoneEdit" class="btn-primary">Done</button>
    </div>

    <footer>
      Works offline. Data stays on this device (local only).
      <div class="version">Hub v0.7 (wallpaper veil • editable home grid)</div>
    </footer>
  </div>

  <!-- Hidden pickers -->
  <input type="file" id="file-picker" accept="image/*" class="sr-only"/>
  <input type="file" id="wallpaper-picker" accept="image/*" class="sr-only"/>

  <!-- Admin Modal (unchanged) -->
  <div class="modal-backdrop" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal">
      <header>
        <div id="adminTitle" style="font-weight:800">Admin Settings</div>
        <button id="adminClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div class="tabs">
          <button class="tab" data-tab="parents" aria-selected="true">Parents</button>
          <button class="tab" data-tab="kids">Kids</button>
        </div>

        <!-- Parents -->
        <section class="tab-panel" data-panel="parents">
          <div class="list" id="parentsList"></div>
          <div class="row">
            <input id="newParentName" class="btn" placeholder="Add parent name" />
            <button id="addParent" class="btn-primary btn-lg">Add Parent</button>
          </div>
          <div class="row">
            <input id="pinInput" class="btn" placeholder="Set Admin PIN (optional)" inputmode="numeric" />
            <button id="savePin" class="btn-primary btn-lg">Save PIN</button>
          </div>
        </section>

        <!-- Kids -->
        <section class="tab-panel" data-panel="kids" style="display:none">
          <div class="list" id="kidsList"></div>
          <div class="row">
            <input id="newKidName" class="btn" placeholder="Add kid name" />
            <button id="addKid" class="btn-primary btn-lg">Add Kid</button>
          </div>
        </section>
      </div>
      <div class="footer">
        <button id="adminSave" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div id="pinModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="pinTitle">
    <div class="modal" style="max-width:420px">
      <header>
        <div id="pinTitle" style="font-weight:800">Enter Admin PIN</div>
        <button id="pinClose" class="btn">✖</button>
      </header>
      <div class="body" style="gap:12px">
        <input id="pinInputModal" class="btn" inputmode="numeric" pattern="\\d*" placeholder="PIN (numbers only)" autofocus />
      </div>
      <div class="footer">
        <button id="pinOk" class="btn-primary btn-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Add Card Modal -->
  <div class="modal-backdrop" id="addCardModal" aria-hidden="true" role="dialog" aria-labelledby="addCardTitle">
    <div class="modal" style="max-width:520px">
      <header>
        <div id="addCardTitle" style="font-weight:800">Add a Card</div>
        <button id="addCardClose" class="btn">✖</button>
      </header>
      <div class="body" id="addCardBody"></div>
      <div class="footer">
        <button id="addCardDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>
<script>
// Fallback Family shim if family.js failed
if (!window.Family) {
  console.warn('family.js not loaded — using fallback Family shim.');
  (function(){
    const K={pin:'hub:family:pin', parents:'hub:family:parents', kids:'hub:family:kids'};
    const uid=()=>Math.random().toString(36).slice(2,10);
    const load=(k,f)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v ?? f;}catch{ return f; } };
    const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    window.Family = {
      setPin(pin){ save(K.pin, pin || null); },
      verifyPin(pin){ const real = load(K.pin, null); return real ? String(real)===String(pin) : true; },
      getParents(){ return load(K.parents, []); },
      upsertParent(p){ const a=this.getParents(); const i=a.findIndex(x=>x.id===p.id);
        if(i>=0) a[i]={...a[i],...p}; else a.push({...p,id:p.id||uid()}); save(K.parents,a); },
      removeParent(id){ save(K.parents, this.getParents().filter(p=>p.id!==id)); },
      getKids(){ return load(K.kids, []); },
      getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false); },
      upsertKid(k){ const a=this.getKids(); const i=a.findIndex(x=>x.id===k.id);
        if(i>=0) a[i]={...a[i],...k}; else a.push({...k,id:k.id||uid(),enabled:true}); save(K.kids,a); },
      removeKid(id){ save(K.kids, this.getKids().filter(k=>k.id!==id)); },
      setKidEnabled(id,en){ const a=this.getKids(); const k=a.find(x=>x.id===id); if(k){ k.enabled=!!en; save(K.kids,a); } },
      onChange(){ return ()=>{}; }
    };
  })();
}
</script>

<!-- Seed PIN once to 4321 -->
<script>
(function seedPinOnce(){
  try{
    const FLAG = 'hub:pinSeeded';
    if (!localStorage.getItem(FLAG)) {
      Family.setPin('4321');
      localStorage.setItem(FLAG, '1');
      console.log('Admin PIN seeded to 4321');
    }
  }catch(e){ console.warn('PIN seed failed', e); }
})();
</script>

<!-- Wallpaper utilities -->
<script>
const WP_KEY = 'hub:wallpaper:dataurl';
(function applyWallpaper(){
  const data = localStorage.getItem(WP_KEY);
  if (data) document.documentElement.style.setProperty('--wallpaper', `url("${data}")`);
})();
function pickWallpaper(){
  const input = document.getElementById('wallpaper-picker');
  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compressImage(file, 2400, 0.85);
    localStorage.setItem(WP_KEY, dataUrl);
    document.documentElement.style.setProperty('--wallpaper', `url("${dataUrl}")`);
    input.value='';
  };
  input.click();
}
function clearWallpaper(){
  localStorage.removeItem(WP_KEY);
  document.documentElement.style.setProperty('--wallpaper', `url('')`);
}
function compressImage(file, maxSide=2400, quality=.85){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}
</script>

<!-- Home modules + editable grid -->
<script>
/* ---------- Registry ---------- */
const MODULES = {
  breakfast: { id:'breakfast', label:'Breakfast Chooser', href:'./breakfast.html', emoji:'🍽️' },
  chores:    { id:'chores',    label:'Chores',            href:'./chores.html',    emoji:'🧹' },
  dinner:    { id:'dinner',    label:'Dinner Planner',    href:'./dinner.html',    emoji:'🍝' },
  calendar:  { id:'calendar',  label:'Family Calendar',   href:'./calendar.html',  emoji:'📅' }
};
/* storage keys */
const LAYOUT_KEY='hub:home:layout';
const HIDDEN_KEY='hub:home:hidden';

/* helpers */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* editing state */
let editing=false;
let selectedId=null;
let pendingSlotIndex=null; // where to add a new card via modal
const app = $('#appRoot');
const grid = $('#grid');

/* default layout from existing modules (order matches your old HTML) */
function defaultLayout(){ return ['breakfast','chores','dinner','calendar'].filter(id=>MODULES[id]); }
function getLayout(){ let a=load(LAYOUT_KEY,null); if(!Array.isArray(a)||!a.length){ a=defaultLayout(); save(LAYOUT_KEY,a); } return a; }
function setLayout(a){ save(LAYOUT_KEY,a); }
function getHidden(){ return load(HIDDEN_KEY,{}); }
function setHidden(map){ save(HIDDEN_KEY,map); }

/* render grid (with placeholders while editing) */
function renderGrid(){
  const layout = getLayout().filter(id=>MODULES[id]);
  const hidden = getHidden();
  const visible = layout.filter(id=>!hidden[id]);

  grid.innerHTML='';

  // how many slots? keep at least current count, top out to next full row
  const cols = matchMedia('(min-width:900px)').matches ? 4 : 2;
  const minSlots = Math.max(visible.length, 4);
  const rows = Math.max(1, Math.ceil(minSlots/cols));
  const totalSlots = editing ? rows*cols + cols*1 /* one extra row while editing */ : rows*cols;

  let visIndex = 0;
  for(let i=0;i<totalSlots;i++){
    const id = visible[visIndex] ?? null;

    if(id){
      // tile
      const m = MODULES[id];
      const a = document.createElement('a');
      a.className='tile';
      a.href = editing ? 'javascript:void(0)' : m.href;
      a.dataset.id = id;
      a.innerHTML = `<div class="emoji">${m.emoji}</div><div class="label">${m.label}</div><div class="hint">Tap to open</div>`;
      if(editing){
        const rm = document.createElement('button');
        rm.className='remove'; rm.textContent='–'; rm.title='Remove from Home';
        rm.onclick=(e)=>{ e.stopPropagation(); e.preventDefault(); removeCard(id); };
        a.appendChild(rm);
        a.onclick=(e)=>{ e.preventDefault(); selectTile(id,a); };
      }
      grid.appendChild(a);
      visIndex++;
    } else {
      // empty slot
      const slot = document.createElement('div');
      slot.className='slot';
      if(editing){
        const p = document.createElement('button');
        p.className='plus'; p.textContent='＋'; p.title='Add card here';
        p.onclick=()=>openAddCardModal(i);
        slot.appendChild(p);
      } else {
        slot.style.visibility='hidden'; // keep even spacing when not editing
      }
      grid.appendChild(slot);
    }
  }
  // reflect selection
  $$('[data-id]', grid).forEach(el=> el.classList.toggle('selected', el.dataset.id===selectedId));
}

/* selection + move by tapping a slot */
function selectTile(id, el){
  if(selectedId===id){ selectedId=null; renderGrid(); return; }
  selectedId=id; renderGrid();
  // next tap on a slot moves it there; we intercept on slot plus handler – simpler UX:
}

/* remove card (hide, not delete module) */
function removeCard(id){
  const hidden=getHidden(); hidden[id]=true; setHidden(hidden);
  selectedId=null; renderGrid();
}

/* add card flow */
const addCardModal = $('#addCardModal');
const addCardBody  = $('#addCardBody');
$('#addCardClose').onclick = ()=>hide(addCardModal);
$('#addCardDone').onclick  = ()=>hide(addCardModal);

function openAddCardModal(slotIndex){
  pendingSlotIndex = slotIndex;
  addCardBody.innerHTML='';
  const layout = getLayout();
  const hidden = getHidden();
  const used = new Set(layout.filter(id=>!hidden[id]));
  const choices = Object.values(MODULES).filter(m=>!used.has(m.id));
  if(!choices.length){
    const p=document.createElement('div'); p.textContent='All cards are already on the Home screen.'; p.style.opacity='.8';
    addCardBody.appendChild(p);
  } else {
    choices.forEach(m=>{
      const row=document.createElement('div');
      row.className='item';
      row.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
          <div class="emoji" style="font-size:26px">${m.emoji}</div>
          <div>${m.label}</div>
        </div>
        <button class="btn-primary">Add</button>`;
      row.querySelector('button').onclick=()=>{ placeCardAt(m.id, pendingSlotIndex); hide(addCardModal); };
      addCardBody.appendChild(row);
    });
  }
  show(addCardModal);
}

function placeCardAt(id, slotIndex){
  const layout = getLayout().filter(x=>MODULES[x]); // clean
  const hidden = getHidden();
  const visible = layout.filter(x=>!hidden[x]);

  // If the card is already in layout but hidden, unhide and place.
  if(!layout.includes(id)) layout.push(id);
  hidden[id]=false; setHidden(hidden);

  // compute columns to know current slot → index insertion
  const cols = matchMedia('(min-width:900px)').matches ? 4 : 2;

  // build a new visible order inserting/placing id at desired slot
  const afterAdd = visible.slice();
  // If it's already visible, remove first (reposition)
  const existingIx = afterAdd.indexOf(id);
  if(existingIx>=0) afterAdd.splice(existingIx,1);

  // clamp slotIndex
  const maxIx = Math.max(0, afterAdd.length);
  const ix = Math.min(Math.max(0, slotIndex), maxIx);
  afterAdd.splice(ix, 0, id);

  // now map back to full layout order: keep any hidden items at the end in their order
  const newLayout = afterAdd.concat(layout.filter(x=>hidden[x]));
  setLayout(newLayout);
  selectedId=null; renderGrid();
}

/* move selected tile to a specific slot (called by slot + when a tile is selected) */
function moveSelectedTo(slotIndex){
  if(!selectedId) return;
  placeCardAt(selectedId, slotIndex);
}

/* Edit mode toggling */
function setEditing(on){
  editing=!!on; app.classList.toggle('editing', editing);
  selectedId=null; renderGrid();
}

/* Menu + PIN gate */
(function menu(){
  const btn = document.getElementById('btnMenu');
  const dd  = document.getElementById('menuDropdown');
  const openDD = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
  const closeDD= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };

  btn?.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?closeDD():openDD(); });
  document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) closeDD(); });

  dd?.addEventListener('click', (e)=>{
    const el = e.target.closest('.menu-item'); if (!el) return;
    const action = el.dataset.action;
    closeDD();
    if (action === 'edithome') {
      setEditing(!editing);
    } else if (action === 'admin') {
      const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
      if (hasPin) requestPinUI(openAdmin);
      else openAdmin();
    } else if (action === 'wallpaper') {
      pickWallpaper();
    } else if (action === 'clearwp') {
      clearWallpaper();
    } else if (action === 'about') {
      alert('Fambam — single-device PWA.\nWallpaper is stored locally on this iPad.');
    }
  });
})();
document.getElementById('btnDoneEdit').onclick = ()=> setEditing(false);

/* PIN modal helpers (unchanged) */
function requestPinUI(onSuccess){
  const m = document.getElementById('pinModal');
  const input = document.getElementById('pinInputModal');
  const ok = document.getElementById('pinOk');
  const x = document.getElementById('pinClose');

  function close(){ m.style.display='none'; m.setAttribute('aria-hidden','true'); input.value=''; ok.onclick = x.onclick = null; }
  function open(){
    m.style.display='flex'; m.setAttribute('aria-hidden','false');
    setTimeout(()=>{ input.focus(); input.setSelectionRange(input.value.length, input.value.length); }, 50);
  }

  ok.onclick = ()=> {
    const pin = input.value.trim();
    if (!/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    if (Family.verifyPin(pin)) { close(); onSuccess(); }
    else { alert('Incorrect PIN.'); input.focus(); input.select(); }
  };
  x.onclick = close;

  open();
}

/* Admin modal logic (unchanged) */
const modal = document.getElementById('adminModal');
document.getElementById('adminClose')?.addEventListener('click', closeAdmin);
document.getElementById('adminSave')?.addEventListener('click', closeAdmin);

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    const tab = t.dataset.tab;
    document.querySelectorAll('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display = (p.dataset.panel===tab?'':'none'));
  });
});

function openAdmin(){
  buildParents();
  buildKids();
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
function closeAdmin(){
  modal.style.display='none'; modal.setAttribute('aria-hidden','true');
}

/* Parents UI */
function buildParents(){
  const list = document.getElementById('parentsList'); list.innerHTML='';
  (Family.getParents?.() || []).forEach(p=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=p.id;
    row.innerHTML = `
      <div class="face">${p.photo?`<img src="${p.photo}" alt="${escapeHtml(p.name)}">`:`<span>${initials(p.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(p.name||'Parent')}" />
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });

  document.getElementById('addParent').onclick = ()=>{
    const name = (document.getElementById('newParentName').value||'').trim(); if(!name) return;
    Family.upsertParent({ name }); document.getElementById('newParentName').value=''; buildParents();
  };
  document.getElementById('savePin').onclick = ()=>{
    const pin = (document.getElementById('pinInput').value||'').trim() || null;
    if (pin && !/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    Family.setPin(pin); alert(pin ? 'PIN saved.' : 'PIN cleared.');
  };

  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertParent({ id, name:e.target.value });
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('parent', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeParent(id); buildParents(); };
  });
}

/* Kids UI */
function buildKids(){
  const list = document.getElementById('kidsList'); list.innerHTML='';
  (Family.getKids?.() || []).forEach(k=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=k.id;
    row.innerHTML = `
      <div class="face">${k.photo?`<img src="${k.photo}" alt="${escapeHtml(k.name)}">`:`<span>${initials(k.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(k.name||'Kid')}" />
      <label class="toggle"><input type="checkbox" ${k.enabled!==false?'checked':''}/> Enabled</label>
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });

  document.getElementById('addKid').onclick = ()=>{
    const name = (document.getElementById('newKidName').value||'').trim(); if(!name) return;
    Family.upsertKid({ name }); document.getElementById('newKidName').value=''; buildKids();
  };

  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertKid({ id, name:e.target.value });
    row.querySelector('input[type="checkbox"]').onchange = (e)=> Family.setKidEnabled(id, e.target.checked);
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('kid', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeKid(id); buildKids(); };
  });
}

/* Shared helpers */
function initials(n){ const p=(n||'').trim(); return p? p[0].toUpperCase() : '?'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

function pickPhoto(kind, id){
  const input = document.getElementById('file-picker');
  const useCamera = confirm('Use camera to take a new photo? (Cancel = choose from Photo Library/Files)');
  if (useCamera) input.setAttribute('capture','environment'); else input.removeAttribute('capture');

  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compress(file, 256, 0.8);
    try{
      if (kind==='kid') Family.upsertKid({ id, photo:dataUrl });
      else Family.upsertParent({ id, photo:dataUrl });
      if (kind==='kid') buildKids(); else buildParents();
    }catch(_){ alert('Could not save photo.'); }
    input.value=''; input.removeAttribute('capture');
  };
  input.click();
}
function compress(file, maxSide=256, quality=0.8){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}

/* Simple modal show/hide */
function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }

/* Boot */
renderGrid();

/* Adjust layout live when breakpoint changes (so plus slots line up) */
matchMedia('(min-width:900px)').addEventListener?.('change', renderGrid);

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
