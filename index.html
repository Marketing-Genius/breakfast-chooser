<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<style>
*, *::before, *::after { box-sizing: border-box; }

:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  --wallpaper:url(''); --wallpaper-shift:40%;
  --slotH: 220px;
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#404c69; overflow-x:hidden;
}
/* Wallpaper */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper);
  background-size: cover; background-repeat:no-repeat;
  background-position: center var(--wallpaper-shift);
  transform: translateZ(0);
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  background: rgba(64,76,105,.9);
  pointer-events:none;
}
/* App */
.app{
  min-height: 100svh;
  display:flex; flex-direction:column; gap:18px;
  padding:20px; max-width:1100px; margin:0 auto;
}
/* Header */
header{
  position:relative; z-index: 9000; isolation:isolate;
  display:flex;justify-content:space-between;align-items:center;
  background:rgba(17,24,39,.5); border:1px solid rgba(11,18,36,.3);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
  backdrop-filter: blur(8px);
}
.title{display:flex;align-items:center;gap:10px}
.title img{height:38px;display:block}
.menu-wrap{position:relative; z-index: 9001; overflow:visible}
.hamburger{font:inherit;cursor:pointer;background:rgba(11,18,36,.6);color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:10px 12px}
.menu-dropdown{
  position:absolute;right:0;top:110%;min-width:260px;z-index:9002 !important;
  background:#111827;border:1px solid #1f2937;border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);padding:6px;display:none
}
.menu-dropdown.open{display:block}
.menu-item{width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:#e5e7eb;border-radius:10px;cursor:pointer}
.menu-item:hover{background:#0b1224}

/* Grid */
#slots{
  margin-top:12px; display:grid; gap:16px;
  grid-template-columns:repeat(4, minmax(0,1fr));
  grid-auto-rows: var(--slotH);
}
@media(max-width:860px){ #slots{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
.slot{ height: var(--slotH); border-radius:16px; position:relative; }
.slot.editing{ outline:2px dashed #334155; background:rgba(2,6,23,.25); }
.slot.editing .add-btn{
  position:absolute; inset:auto 10px 10px auto;
  background:#0b1224; border:1px dashed #334155; color:#cbd5e1;
  border-radius:999px; width:44px; height:44px; display:grid; place-items:center; cursor:pointer;
}

/* Tile */
.tile{
  position:relative;
  display:flex;flex-direction:column;gap:10px;align-items:flex-start;
  background:rgba(31,41,55,.9);border:1px solid rgba(31,41,55,.95);
  border-radius:16px;padding:16px;text-decoration:none;color:var(--text);
  box-shadow:var(--shadow);backdrop-filter: blur(4px);
  height:100%; overflow:hidden;
}
.tile .emoji{font-size:36px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
.tile .label{font-weight:800}
.tile .hint{opacity:.8}

/* Breakfast preview */
.bf-box{
  margin-top:6px; width:100%;
  background:#081228; border:1px solid #27324a;
  border-radius:16px; padding:12px;
  max-height: calc(var(--slotH) - 72px);
  overflow:hidden;
}
.bf-date{font-size:.9rem;font-weight:800}
.bf-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.bf-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px 12px;
  margin-top:10px;
}
.bf-item{display:flex; align-items:center; gap:10px; min-height:40px}
.bf-face{width:34px;height:34px;border-radius:50%;overflow:hidden;display:grid;place-items:center;background:#334155;color:#e5e7eb;font-size:.95rem;font-weight:800}
.bf-face img{width:100%;height:100%;object-fit:cover}
.bf-emoji{font-size:1.4rem; line-height:1}

/* Dinner preview */
.dp-box{margin-top:6px;width:100%;background:#081228;border:1px solid #27324a;border-radius:16px;padding:12px;max-height:calc(var(--slotH)-72px);overflow:hidden}
.dp-title{font-size:.95rem;font-weight:800}
.dp-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.dp-rows{display:grid; gap:10px; margin-top:10px}
.dp-row{display:flex; align-items:center; justify-content:space-between}
.dp-row .who{font-weight:800}
.dp-icons{display:flex; align-items:center; gap:10px; font-size:1.4rem; line-height:1}

/* Chores preview (avatar + emojis) */
.ch-box{margin-top:6px;width:100%;background:#081228;border:1px solid #27324a;border-radius:16px;padding:12px;max-height:calc(var(--slotH)-72px);overflow:hidden}
.ch-title{font-size:.95rem;font-weight:800}
.ch-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.ch-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 12px;margin-top:10px}
.ch-item{display:flex; align-items:center; gap:10px; min-height:40px}
.ch-icons{display:flex; align-items:center; gap:10px; font-size:1.4rem; line-height:1}

/* Points preview (2×2) */
.pt-box{margin-top:6px;width:100%;background:#081228;border:1px solid #27324a;border-radius:16px;padding:12px;max-height:calc(var(--slotH)-72px);overflow:hidden}
.pt-title{font-size:.95rem;font-weight:800}
.pt-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.pt-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px 12px;margin-top:10px}
.pt-item{display:flex; align-items:center; gap:10px; min-height:40px}
.pt-num{font-weight:800}

/* Photos tile */
.tile.photo-only{ padding:0; border:none; background:transparent; box-shadow:none; }
.photo-prev{ position:absolute; inset:0; border-radius:16px; overflow:hidden; z-index:0; opacity:1; }
.photo-prev img{ width:100%; height:100%; object-fit:cover; display:block; touch-action:pan-y; }
.tile.photos-card .emoji, .tile.photos-card .label, .tile.photos-card .hint{ display: none; }
.tile.photos-card .minus{ display:none; }
.editing .tile.photos-card .minus{ display:grid; background: rgba(0,0,0,.4); border-color:#000; }
.tile.photos-card::before{ content:""; position:absolute; inset:0; border-radius:16px; box-shadow: var(--shadow); pointer-events:none; }
.open-link{
  position:absolute; top:8px; right:8px; width:32px; height:32px; border-radius:999px;
  display:grid; place-items:center; background:rgba(0,0,0,.55); color:#e5e7eb; border:1px solid rgba(255,255,255,.2);
  font-weight:800; cursor:pointer; z-index:5;
}
.editing .open-link{ display:none; }

/* Modal + form + edit bar */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);background:rgba(17,24,39,.98);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937}
.modal .body{padding:14px 16px;display:grid;gap:18px;max-height:70vh;overflow:auto}
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;background:#0b1224;border:1px solid #334155;cursor:pointer;color:var(--text)}
.tab[aria-selected="true"]{outline:2px solid var(--accent)}
.list{display:grid; gap:12px;}
.item{display:flex;align-items:center;gap:10px;background:#1f2937;border:1px solid #111827;border-radius:12px;padding:12px}
.item .grow{flex:1}
.face{width:48px;height:48px;border-radius:50%;background:#0b1224;display:grid;place-items:center;font-size:22px;border:2px solid #334155;overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0;}
.btn{font:inherit;color:#e5e7eb;background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px 12px;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#001018;border:none;font-weight:800}
.btn-lg{padding:12px 16px;border-radius:14px;font-weight:800}
.btn-warn{background:#3f1620;border:1px solid #7f1d1d;color:#fecaca}
.btn[disabled]{opacity:.5;filter:grayscale(1);pointer-events:none}
.toggle{display:inline-flex;align-items:center;gap:8px}
#editBar{display:none; align-items:center; justify-content:space-between;margin-top:6px; padding:10px 12px; border-radius:12px;background:rgba(17,24,39,.65); border:1px solid #1f2937;}
#editBar.show{display:flex}

/* All Pages modal list */
.pages-grid{display:grid;gap:12px}
.page-link{
  display:flex;align-items:center;gap:10px;
  background:#1f2937;border:1px solid #111827;border-radius:12px;
  padding:12px;text-decoration:none;color:var(--text)
}
.page-link .emoji{font-size:22px}
.page-link .meta{opacity:.8}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <img src="fambam.png" alt="Fambam">
      </div>
      <div class="menu-wrap">
        <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">☰</button>
        <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
          <button class="menu-item" data-action="allpages" role="menuitem">All Pages</button>
          <button class="menu-item" data-action="edithome" role="menuitem">Edit Home</button>
          <button class="menu-item" data-action="admin" role="menuitem">Admin Settings</button>
          <button class="menu-item" data-action="about" role="menuitem">About</button>
        </div>
      </div>
    </header>

    <!-- Edit bar -->
    <div id="editBar">
      <div>Tap a card, then tap a slot to move it. Use “+” to add. Tap “−” on a card to remove.</div>
      <div style="display:flex;gap:10px">
        <button id="btnAddAnywhere" class="btn">Add/Remove Card</button>
        <button id="btnDoneEdit" class="btn-primary">Done</button>
      </div>
    </div>

    <!-- Fixed grid of 16 slots -->
    <main id="slots" aria-label="Home grid"></main>
  </div>

  <!-- Hidden pickers -->
  <input type="file" id="file-picker" accept="image/*" class="sr-only"/>
  <input type="file" id="wallpaper-picker" accept="image/*" class="sr-only"/>

  <!-- Admin Modal -->
  <div class="modal-backdrop" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal">
      <header>
        <div id="adminTitle" style="font-weight:800">Admin Settings</div>
        <button id="adminClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div class="tabs">
          <button class="tab" data-tab="parents" aria-selected="true">Parents</button>
          <button class="tab" data-tab="kids">Kids</button>
          <button class="tab" data-tab="global">Global Settings</button>
        </div>

        <!-- Parents -->
        <section class="tab-panel" data-panel="parents">
          <div class="list" id="parentsList"></div>
          <div class="row">
            <input id="newParentName" class="btn" placeholder="Add parent name" />
            <button id="addParent" class="btn-primary btn-lg">Add Parent</button>
          </div>
          <div class="row">
            <input id="pinInput" class="btn" placeholder="Set Admin PIN (optional)" inputmode="numeric" />
            <button id="savePin" class="btn-primary btn-lg">Save PIN</button>
          </div>
        </section>

        <!-- Kids -->
        <section class="tab-panel" data-panel="kids" style="display:none">
          <div class="list" id="kidsList"></div>
          <div class="row">
            <input id="newKidName" class="btn" placeholder="Add kid name" />
            <button id="addKid" class="btn-primary btn-lg">Add Kid</button>
          </div>
        </section>

        <!-- Global Settings -->
        <section class="tab-panel" data-panel="global" style="display:none">
          <div class="list">
            <div class="item">
              <div class="grow">
                <div style="font-weight:800">Wallpaper</div>
                <div style="opacity:.8">Change the background for all pages.</div>
              </div>
              <button class="btn" id="btnPickWP">Change</button>
              <button class="btn-warn" id="btnClearWP">Clear</button>
            </div>

            <div class="item">
              <div class="grow">
                <div style="font-weight:800">Theme</div>
                <div style="opacity:.8">Placeholder — presets coming soon.</div>
              </div>
              <select id="themePicker" class="btn">
                <option value="system">Default (Dark)</option>
                <option value="light">Light (placeholder)</option>
                <option value="cyan">Cyan Accent (placeholder)</option>
              </select>
            </div>
          </div>
        </section>
      </div>
      <div class="footer">
        <button id="adminSave" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div id="pinModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="pinTitle">
    <div class="modal" style="max-width:420px">
      <header>
        <div id="pinTitle" style="font-weight:800">Enter Admin PIN</div>
        <button id="pinClose" class="btn">✖</button>
      </header>
      <div class="body" style="gap:12px">
        <input id="pinInputModal" class="btn" inputmode="numeric" pattern="\\d*" placeholder="PIN (numbers only)" autofocus />
      </div>
      <div class="footer">
        <button id="pinOk" class="btn-primary btn-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Add / Remove Cards Modal -->
  <div id="addCardModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="addCardTitle">
    <div class="modal" style="max-width:560px">
      <header>
        <div id="addCardTitle" style="font-weight:800">Add / Remove Cards</div>
        <button id="addCardClose" class="btn">✖</button>
      </header>
      <div class="body" id="addCardBody"></div>
      <div class="footer">
        <button id="addCardDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- All Pages Modal -->
  <div id="pagesModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="pagesTitle">
    <div class="modal" style="max-width:520px">
      <header>
        <div id="pagesTitle" style="font-weight:800">All Pages</div>
        <button id="pagesClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div id="pagesList" class="pages-grid"></div>
      </div>
      <div class="footer">
        <button id="pagesDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="aboutTitle">
    <div class="modal" style="max-width:600px">
      <header>
        <div id="aboutTitle" style="font-weight:800">About Fambam</div>
        <button id="aboutClose" class="btn">✖</button>
      </header>
      <div class="body">
        <p><b>Fambam</b> — single-device family hub (PWA). Data stays on this iPad.</p>
        <ul>
          <li>Wallpaper is stored locally and never uploaded.</li>
          <li>Admin-gated settings via PIN.</li>
          <li>Home supports grid placement by tapping a card then a slot.</li>
        </ul>
        <p style="opacity:.75">Works offline. Data stays on this device (local only).</p>
      </div>
      <div class="footer">
        <button class="btn-primary" id="aboutOk">OK</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>
<script>
if (!window.Family) {
  console.warn('family.js not loaded — using fallback Family shim.');
  (function(){
    const K={pin:'hub:family:pin', parents:'hub:family:parents', kids:'hub:family:kids'};
    const uid=()=>Math.random().toString(36).slice(2,10);
    const load=(k,f)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v ?? f;}catch{ return f; } };
    const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    window.Family = {
      setPin(pin){ save(K.pin, pin || null); },
      verifyPin(pin){ const real = load(K.pin, null); return real ? String(real)===String(pin) : true; },
      getParents(){ return load(K.parents, []); },
      upsertParent(p){ const a=this.getParents(); const i=a.findIndex(x=>x.id===p.id);
        if(i>=0) a[i]={...a[i],...p}; else a.push({...p,id:p.id||uid()}); save(K.parents,a); },
      removeParent(id){ save(K.parents, this.getParents().filter(p=>p.id!==id)); },
      getKids(){ return load(K.kids, []); },
      getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false); },
      upsertKid(k){ const a=this.getKids(); const i=a.findIndex(x=>x.id===k.id);
        if(i>=0) a[i]={...a[i],...k}; else a.push({...k,id:k.id||uid(),enabled:true}); save(K.kids,a); },
      removeKid(id){ save(K.kids, this.getKids().filter(k=>k.id!==id)); },
      setKidEnabled(id,en){ const a=this.getKids(); const k=a.find(x=>x.id===id); if(k){ k.enabled=!!en; save(K.kids,a); } },
      onChange(){ return ()=>{}; }
    };
  })();
}
</script>

<!-- Seed PIN once to 4321 -->
<script>
(function seedPinOnce(){
  try{
    const FLAG = 'hub:pinSeeded';
    if (!localStorage.getItem(FLAG)) {
      Family.setPin('4321');
      localStorage.setItem(FLAG, '1');
      console.log('Admin PIN seeded to 4321');
    }
  }catch(e){ console.warn('PIN seed failed', e); }
})();
</script>

<!-- Wallpaper helpers -->
<script>
function pickWallpaper(){
  const input = document.getElementById('wallpaper-picker');
  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compressImage(file, 2400, 0.85);

    if (window.Wallpaper && typeof Wallpaper.set === 'function') {
      Wallpaper.set(dataUrl);
    } else {
      const KEY = 'hub:wallpaper:dataurl';
      localStorage.setItem(KEY, dataUrl);
      document.documentElement.style.setProperty('--wallpaper', `url("${dataUrl}")`);
    }
    input.value='';
  };
  input.click();
}
function clearWallpaper(){
  if (window.Wallpaper && typeof Wallpaper.clear === 'function') {
    Wallpaper.clear();
  } else {
    const KEY = 'hub:wallpaper:dataurl';
    localStorage.removeItem(KEY);
    document.documentElement.style.setProperty('--wallpaper', `url('')`);
  }
}
function compressImage(file, maxSide=2400, quality=.85){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}
</script>

<!-- Menu + PIN gate + All Pages -->
<script>
(function menu(){
  const btn = document.getElementById('btnMenu');
  const dd  = document.getElementById('menuDropdown');
  const openDD = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
  const closeDD= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };

  btn && btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?closeDD():openDD(); });
  document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) closeDD(); });

  dd && dd.addEventListener('click', (e)=>{
    const el = e.target.closest('.menu-item'); if (!el) return;
    const action = el.dataset.action;
    closeDD();
    if (action === 'allpages') openPages();
    else if (action === 'edithome') toggleEdit(true);
    else if (action === 'admin') {
      const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
      if (hasPin) requestPinUI(openAdmin); else openAdmin();
    } else if (action === 'about') showModal('aboutModal', true);
  });
})();
</script>

<!-- PIN modal helpers -->
<script>
function requestPinUI(onSuccess){
  const m = document.getElementById('pinModal');
  const input = document.getElementById('pinInputModal');
  const ok = document.getElementById('pinOk');
  const x = document.getElementById('pinClose');

  function close(){ m.style.display='none'; m.setAttribute('aria-hidden','true'); input.value=''; ok.onclick = x.onclick = null; input.onkeydown = null; }
  function open(){
    m.style.display='flex'; m.setAttribute('aria-hidden','false');
    setTimeout(()=>{ input.focus(); input.setSelectionRange(input.value.length, input.value.length); }, 50);
  }
  function submit(){
    const pin = input.value.trim();
    if (!/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    if (Family.verifyPin(pin)) { close(); onSuccess(); }
    else { alert('Incorrect PIN.'); input.focus(); input.select(); }
  }
  ok.onclick = submit;
  x.onclick = close;
  input.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); } };
  open();
}
window.addEventListener('load', ()=>{
  if (location.hash === '#admin') {
    const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
    if (hasPin) requestPinUI(openAdmin); else openAdmin();
  }
});
</script>

<!-- Admin modal + All Pages logic -->
<script>
const modal = document.getElementById('adminModal');
document.getElementById('adminClose')?.addEventListener('click', closeAdmin);
document.getElementById('adminSave')?.addEventListener('click', closeAdmin);

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    const tab = t.dataset.tab;
    document.querySelectorAll('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display = (p.dataset.panel===tab?'':'none'));
  });
});

function openAdmin(){
  buildParents(); buildKids();
  const pick = document.getElementById('btnPickWP');
  const clr  = document.getElementById('btnClearWP');
  const theme= document.getElementById('themePicker');
  pick && (pick.onclick = pickWallpaper);
  clr && (clr.onclick = clearWallpaper);
  theme && (theme.onchange = (e)=>localStorage.setItem('hub:theme', e.target.value));
  showModal('adminModal', true);
}
function closeAdmin(){ showModal('adminModal', false); }

/* All Pages */
function openPages(){
  const list = document.getElementById('pagesList'); list.innerHTML='';
  CARDS.forEach(c=>{
    const a=document.createElement('a');
    a.href=c.href; a.className='page-link';
    a.innerHTML=`<div class="emoji">${c.emoji}</div><div><div style="font-weight:800">${c.label}</div><div class="meta">${c.hint||''}</div></div>`;
    list.appendChild(a);
  });
  showModal('pagesModal', true);
}
document.getElementById('pagesDone').onclick=()=>showModal('pagesModal', false);
document.getElementById('pagesClose').onclick=()=>showModal('pagesModal', false);

/* Parents UI */
function buildParents(){
  const list = document.getElementById('parentsList'); if(!list) return; list.innerHTML='';
  (Family.getParents?.() || []).forEach(p=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=p.id;
    row.innerHTML = `
      <div class="face">${p.photo?`<img src="${p.photo}" alt="${escapeHtml(p.name)}">`:`<span>${initials(p.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(p.name||'Parent')}" />
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });
  const addBtn = document.getElementById('addParent');
  const nameIn = document.getElementById('newParentName');
  addBtn && (addBtn.onclick = ()=>{
    const name = (nameIn?.value||'').trim(); if(!name) return;
    Family.upsertParent({ name }); if(nameIn) nameIn.value=''; buildParents();
  });
  const savePin = document.getElementById('savePin');
  const pinIn   = document.getElementById('pinInput');
  savePin && (savePin.onclick = ()=>{
    const pin = (pinIn?.value||'').trim() || null;
    if (pin && !/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    Family.setPin(pin); alert(pin ? 'PIN saved.' : 'PIN cleared.');
  });
  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertParent({ id, name:e.target.value });
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('parent', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeParent(id); buildParents(); };
  });
}
/* Kids UI */
function buildKids(){
  const list = document.getElementById('kidsList'); if(!list) return; list.innerHTML='';
  (Family.getKids?.() || []).forEach(k=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=k.id;
    row.innerHTML = `
      <div class="face">${k.photo?`<img src="${k.photo}" alt="${escapeHtml(k.name)}">`:`<span>${initials(k.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(k.name||'Kid')}" />
      <label class="toggle"><input type="checkbox" ${k.enabled!==false?'checked':''}/> Enabled</label>
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });
  const addBtn = document.getElementById('addKid');
  const nameIn = document.getElementById('newKidName');
  addBtn && (addBtn.onclick = ()=>{
    const name = (nameIn?.value||'').trim(); if(!name) return;
    Family.upsertKid({ name }); if(nameIn) nameIn.value=''; buildKids();
  });
  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertKid({ id, name:e.target.value });
    row.querySelector('input[type="checkbox"]').onchange = (e)=> Family.setKidEnabled(id, e.target.checked);
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('kid', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeKid(id); buildKids(); };
  });
}
/* helpers */
function initials(n){ const p=(n||'').trim(); return p? p[0].toUpperCase() : '?'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
function pickPhoto(kind, id){
  const input = document.getElementById('file-picker');
  input && input.removeAttribute('capture');
  if(!input) return;
  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compress(file, 256, 0.8);
    try{
      if (kind==='kid') Family.upsertKid({ id, photo:dataUrl });
      else Family.upsertParent({ id, photo:dataUrl });
      if (kind==='kid') buildKids(); else buildParents();
    }catch(_){ alert('Could not save photo.'); }
    input.value='';
  };
  input.click();
}
function compress(file, maxSide=256, quality=0.8){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}
</script>

<!-- Home grid logic -->
<script>
const SLOT_KEY = 'hub:home:slots:v2';
const SLOTS_TOTAL = 16;

const CARDS = [
  {id:'breakfast', href:'./breakfast.html', emoji:'🍽️', label:'Breakfast', hint:''},
  {id:'dinner',    href:'./dinner.html',    emoji:'🍝', label:'Dinner Planner', hint:'Weekly plan'},
  {id:'chores',    href:'./chores.html',    emoji:'🧹', label:'Chores',          hint:'Weekly rotation'},
  {id:'points',    href:'./points.html',    emoji:'⭐', label:'Points',          hint:'Leaderboard'},
  {id:'calendar',  href:'./calendar.html',  emoji:'📅', label:'Family Calendar', hint:'Events & activities'},
  {id:'photos',    href:'./photos.html',    emoji:'🖼️', label:'Photos',          hint:'Slideshow'}
];
const byId = Object.fromEntries(CARDS.map(c=>[c.id,c]));

function loadSlots(){
  try{
    const v=JSON.parse(localStorage.getItem(SLOT_KEY));
    if(Array.isArray(v)) return v.slice(0,SLOTS_TOTAL).concat(Array(SLOTS_TOTAL).fill(null)).slice(0,SLOTS_TOTAL);
  }catch{}
  const seed = ['breakfast','dinner','chores','calendar','points'];
  return seed.concat(Array(SLOTS_TOTAL-seed.length).fill(null));
}
function saveSlots(a){ localStorage.setItem(SLOT_KEY, JSON.stringify(a)); }

let slots = loadSlots();
let isEditing = false;
let selectedCardId = null;
let selectedFromSlot = -1;

const $  = (s,e=document)=>e.querySelector(s);
const $$ = (s,e=document)=>Array.prototype.slice.call(e.querySelectorAll(s));

function safelyGetPhotoList(){
  try{ const arr = JSON.parse(localStorage.getItem('photos:list')) || []; return Array.isArray(arr)?arr:[]; }
  catch{ return []; }
}

/* Local-date helpers */
function todayISO(){ const d=new Date(); const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), dd=d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${dd}`; }
function niceToday(){ return new Date().toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }

/* Week helpers (Mon–Sun) */
function startOfWeekMonday(d=new Date()){ const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const day = (dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); return dt; }
function thisMondayISO(){ const m = startOfWeekMonday(new Date()); const y=m.getFullYear(), mm=(m.getMonth()+1).toString().padStart(2,'0'), dd=m.getDate().toString().padStart(2,'0'); return `${y}-${mm}-${dd}`; }
function todayDowShort(){ return new Date().toLocaleDateString('en-US',{weekday:'short'}); }
function emojiFromLabel(label){ const s=(label||'').trim(); return s ? Array.from(s)[0] : ''; }

function renderGrid(){
  const wrap = $('#slots'); if(!wrap) return; wrap.innerHTML='';
  for(let i=0;i<SLOTS_TOTAL;i++){
    const div = document.createElement('div');
    div.className = 'slot' + (isEditing?' editing':''); div.dataset.pos = i;
    const id = slots[i];
    if(id && byId[id]){
      const t = renderTile(byId[id], i);
      if(isEditing){
        t.addEventListener('click', (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          if(selectedCardId===id){ selectedCardId=null; selectedFromSlot=-1; t.classList.remove('selecting'); return; }
          $$('.tile').forEach(x=>x.classList.remove('selecting'));
          selectedCardId = id; selectedFromSlot = i; t.classList.add('selecting');
        });
      }
      div.appendChild(t);
    } else if(isEditing){
      const add = document.createElement('button');
      add.className='add-btn'; add.textContent='+'; add.title='Add card';
      add.onclick=(ev)=>{ ev.stopPropagation(); openAddRemove(i); };
      div.appendChild(add);
    }
    div.addEventListener('click', ()=>{
      if(!isEditing || selectedCardId==null) return;
      const to = i, from = selectedFromSlot;
      if(from===to) return;
      const idB = slots[to];
      slots[to] = selectedCardId;
      slots[from] = idB ?? null;
      selectedCardId=null; selectedFromSlot=-1;
      saveSlots(slots); renderGrid();
    });
    wrap.appendChild(div);
  }
}

function renderTile(c, slotIndex){
  const a = document.createElement('a'); a.href = c.href; a.className='tile';

  if(c.id === 'photos'){
    const list = safelyGetPhotoList();
    if(list.length) a.classList.add('photos-card');
    if(list.length){
      a.classList.add('photo-only');
      a.innerHTML = `
        <button class="open-link" title="Open Photos" aria-label="Open Photos">↗</button>
        <div class="photo-prev"><img alt=""></div>
        <button class="minus" type="button">−</button>`;
      const img = a.querySelector('img');
      const openBtn = a.querySelector('.open-link');
      openBtn.addEventListener('click',(e)=>{ /* allow anchor to navigate */ });

      let idx = 0, timerId = null;
      const show = (i)=>{ idx = (i + list.length) % list.length; img.src = list[idx]; };
      const startTimer = ()=>{ clearInterval(timerId); const cadence = Number(localStorage.getItem('photos:cadence_ms')) || 10000; timerId = setInterval(()=> show(idx+1), cadence); };

      show(0); startTimer();

      img.addEventListener('click', (e)=>{
        if(isEditing) return;
        clearInterval(timerId); show(idx+1); startTimer();
        e.preventDefault(); e.stopPropagation();
      });

      let startX=null;
      img.addEventListener('pointerdown', (ev)=>{ startX=ev.clientX; img.setPointerCapture(ev.pointerId); });
      img.addEventListener('pointerup', (ev)=>{
        if(startX==null) return; const dx=ev.clientX-startX; startX=null;
        if(Math.abs(dx)>30){ clearInterval(timerId); show(idx+(dx<0?1:-1)); startTimer(); ev.preventDefault(); ev.stopPropagation(); }
      });

    } else {
      a.innerHTML = `<div class="label">${c.label}</div><div class="hint">${c.hint||''}</div><button class="minus" type="button">−</button>`;
    }

  } else if (c.id === 'breakfast') {
    a.innerHTML = `
      <div class="label">Breakfast</div>
      <div class="bf-box">
        <div class="bf-date">Today · ${niceToday()}</div>
        <div class="bf-empty">No selections yet — tap Breakfast.</div>
        <div class="bf-grid" aria-label="Breakfast selections" style="display:none"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const menu = JSON.parse(localStorage.getItem('bf:menu')||'[]');
      const key  = 'bf:day:'+todayISO();
      const day  = JSON.parse(localStorage.getItem(key)||'{}');
      const kids = (Family.getKids?.() || []);
      const entries = Object.entries(day);
      const emptyMsg = a.querySelector('.bf-empty');
      const grid = a.querySelector('.bf-grid');
      if (entries.length){
        emptyMsg.style.display='none'; grid.style.display='grid';
        const byName = (id)=> (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        entries.sort((a,b)=> byName(a[0]).localeCompare(byName(b[0])));
        for(const [kidId, idx] of entries.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId); const choice = menu?.[idx]; if(!choice) continue;
          const cell = document.createElement('div'); cell.className='bf-item';
          const face = kid?.photo ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>` : `<span class="bf-face">${(kid?.name||'?')[0]?.toUpperCase()||'?'}</span>`;
          cell.innerHTML = `${face}<span class="bf-emoji">${choice.emoji||'❓'}</span>`; grid.appendChild(cell);
        }
      }
    }catch(err){ console.warn('Breakfast preview error', err); }

  } else if (c.id === 'dinner') {
    a.innerHTML = `
      <div class="label">Dinner Planner</div>
      <div class="dp-box">
        <div class="dp-title">Tonight’s Dinner</div>
        <div class="dp-empty">No selections yet — tap Dinner Planner.</div>
        <div class="dp-rows" style="display:none">
          <div class="dp-row"><div class="who">Kids</div><div class="dp-icons" data-row="kids"></div></div>
          <div class="dp-row"><div class="who">Parents</div><div class="dp-icons" data-row="parents"></div></div>
        </div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const mISO = thisMondayISO();
      const plan = JSON.parse(localStorage.getItem('dp:plan:'+mISO)||'null') || null;
      const dow  = todayDowShort();
      const data = plan?.days?.[dow] || null;
      const emptyMsg = a.querySelector('.dp-empty'), rowsWrap = a.querySelector('.dp-rows');
      if (data){
        const kidsIcons=[], parsIcons=[];
        const kMain = emojiFromLabel(data.kids?.main), kSide = emojiFromLabel(data.kids?.side);
        const pMain = emojiFromLabel(data.parents?.main), pSide = emojiFromLabel(data.parents?.side);
        const dEmoji = emojiFromLabel(data.dessert);
        if (kMain) kidsIcons.push(kMain); if (kSide) kidsIcons.push(kSide);
        if (pMain) parsIcons.push(pMain); if (pSide) parsIcons.push(pSide);
        if (dEmoji){ kidsIcons.push(dEmoji); parsIcons.push(dEmoji); }
        if (kidsIcons.length || parsIcons.length){
          emptyMsg.style.display='none'; rowsWrap.style.display='grid';
          a.querySelector('.dp-icons[data-row="kids"]').innerHTML = kidsIcons.map(e=>`<span>${e}</span>`).join('');
          a.querySelector('.dp-icons[data-row="parents"]').innerHTML = parsIcons.map(e=>`<span>${e}</span>`).join('');
        }
      }
    }catch(err){ console.warn('Dinner preview error', err); }

  } else if (c.id === 'chores') {
    a.innerHTML = `
      <div class="label">Chores</div>
      <div class="ch-box">
        <div class="ch-title">This Week</div>
        <div class="ch-empty">No assignments yet — tap Chores.</div>
        <div class="ch-grid" style="display:none" aria-label="Chore assignments"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const mISO = thisMondayISO();
      const assigns = JSON.parse(localStorage.getItem('ch:assign:'+mISO) || '{}') || {};
      const choreList = JSON.parse(localStorage.getItem('ch:chores:list') || '[]') || [];
      const kids = (Family.getKids?.() || []);
      const choresById = Object.fromEntries(choreList.map(c=>[c.id, c.label]));
      const CHORE_EMOJI = {
        'set the table':'🍽️','vacuum':'🧹',
        'feed dogs':'🐶','feed the dogs':'🐶',
        'trash':'🗑️','take out trash':'🗑️'
      };
      const symbolForChore = (label)=>{
        const s=(label||'').trim().toLowerCase();
        for(const key in CHORE_EMOJI){ if(s.startsWith(key)) return CHORE_EMOJI[key]; }
        const g = Array.from(label||''); return g.length ? g[0] : '•';
      };
      const byKid = {};
      Object.entries(assigns).forEach(([choreId, kidId])=>{
        const sym = symbolForChore(choresById[choreId]||''); (byKid[kidId] ||= []).push(sym);
      });
      const entries = Object.entries(byKid);
      const empty = a.querySelector('.ch-empty'), grid  = a.querySelector('.ch-grid');
      if(entries.length){
        empty.style.display='none'; grid.style.display='grid';
        const nameOf = id => (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        entries.sort((a,b)=> nameOf(a[0]).localeCompare(nameOf(b[0])));
        for(const [kidId, syms] of entries.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId);
          const face = kid?.photo ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>` : `<span class="bf-face">${(kid?.name||'?')[0]?.toUpperCase()||'?'}</span>`;
          const row = document.createElement('div'); row.className='ch-item';
          row.innerHTML = `${face}<div class="ch-icons">${syms.slice(0,3).map(e=>`<span>${e}</span>`).join('')}</div>`;
          grid.appendChild(row);
        }
      }
    }catch(err){ console.warn('Chores preview error', err); }

  } else if (c.id === 'points') {
    a.innerHTML = `
      <div class="label">Points</div>
      <div class="pt-box">
        <div class="pt-title">Leaderboard</div>
        <div class="pt-empty">No points yet — tap Points.</div>
        <div class="pt-grid" style="display:none"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const balances = JSON.parse(localStorage.getItem('pts:balances')||'{}') || {};
      const kids = (Family.getKids?.() || []);
      const entries = Object.entries(balances).filter(([,v])=> typeof v==='number');
      const grid = a.querySelector('.pt-grid'), empty = a.querySelector('.pt-empty');
      if(entries.length){
        empty.style.display='none'; grid.style.display='grid';
        const nameOf = id => (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        entries.sort((a,b)=> b[1]-a[1] || nameOf(a[0]).localeCompare(nameOf(b[0])));
        for(const [kidId, pts] of entries.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId);
          const face = kid?.photo ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>` : `<span class="bf-face">${(kid?.name||'?')[0]?.toUpperCase()||'?'}</span>`;
          const cell = document.createElement('div'); cell.className='pt-item';
          cell.innerHTML = `${face}<div class="pt-num">${Number(pts)||0}</div>`; grid.appendChild(cell);
        }
      }
    }catch(err){ console.warn('Points preview error', err); }

  } else {
    a.innerHTML = `<div class="emoji">${c.emoji}</div><div class="label">${c.label}</div><div class="hint">${c.hint||''}</div><button class="minus" type="button">−</button>`;
  }

  if(isEditing){ a.addEventListener('click', (e)=>e.preventDefault()); }

  const minus = a.querySelector('.minus');
  if(minus){
    ['click','pointerdown','touchstart','mousedown'].forEach(evt=>{
      minus.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); }, {passive:false});
    });
    minus.addEventListener('click', ()=>{
      slots[slotIndex]=null; selectedCardId=null; selectedFromSlot=-1; saveSlots(slots); renderGrid();
    });
  }
  return a;
}

/* Edit controls / modals */
function toggleEdit(on){
  isEditing = !!on;
  $('#editBar').classList.toggle('show', isEditing);
  selectedCardId=null; selectedFromSlot=-1;
  renderGrid();
}
document.getElementById('btnDoneEdit').onclick = ()=> toggleEdit(false);

function openAddRemove(targetIndex){
  const placed = new Set(slots.filter(Boolean));
  const body = document.getElementById('addCardBody'); body.innerHTML='';
  CARDS.forEach(c=>{
    const isOnHome = placed.has(c.id);
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`
      <div class="grow">${c.emoji} <b>${c.label}</b><div style="opacity:.8">${c.hint||''}</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-add>Add</button>
        <button class="btn-warn" data-remove>Remove</button>
      </div>`;
    const btnAdd = row.querySelector('[data-add]');
    const btnRem = row.querySelector('[data-remove]');
    if(isOnHome){ btnAdd.setAttribute('disabled',''); } else { btnRem.setAttribute('disabled',''); }
    btnAdd.onclick=()=>{
      const idx = (typeof targetIndex==='number') ? targetIndex : slots.findIndex(x=>!x);
      if(idx<0){ alert('No empty slot available. Remove a card first.'); return; }
      slots[idx]=c.id; saveSlots(slots); renderGrid(); openAddRemove(idx);
    };
    btnRem.onclick=()=>{
      const ix = slots.findIndex(x=>x===c.id);
      if(ix>=0){ slots[ix]=null; saveSlots(slots); renderGrid(); }
      openAddRemove(targetIndex);
    };
    body.appendChild(row);
  });
  showModal('addCardModal', true);
}
document.getElementById('addCardDone').onclick=()=>showModal('addCardModal', false);
document.getElementById('addCardClose').onclick=()=>showModal('addCardModal', false);
document.getElementById('btnAddAnywhere').onclick=()=>{
  const firstEmpty = slots.findIndex(x=>!x);
  openAddRemove(firstEmpty<0?0:firstEmpty);
};

function showModal(id, show){
  const m=document.getElementById(id); if(!m) return;
  if(show){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
  else    { m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
document.getElementById('aboutOk')?.addEventListener('click',()=>showModal('aboutModal',false));
document.getElementById('aboutClose')?.addEventListener('click',()=>showModal('aboutModal',false));
</script>

<!-- Boot + SW -->
<script>
renderGrid();
try { Family.onChange && Family.onChange(()=>{ renderGrid(); }); } catch(_){}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>