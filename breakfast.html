<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Breakfast Chooser</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{--panel:#111827;--card:#1f2937;--muted:#6b7280;--text:#e5e7eb;--accent:#22d3ee;--bg:#0f172a;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1026 0%,#0f172a 100%);color:var(--text);-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:18px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid #111827;box-shadow:var(--shadow);border-radius:var(--radius);padding:14px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:800;letter-spacing:.2px}
.title .small{font-weight:600;font-size:.8rem;color:var(--muted)}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
input[type="date"],button{font:inherit;color:var(--text);background:var(--card);border:1px solid #374151;border-radius:12px;padding:10px 14px}
button{cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#001018;border:none;font-weight:700}
.btn-ghost{background:transparent;border:1px dashed #334155;color:var(--muted)}
.icon-btn{padding:6px 10px;border-radius:10px;border:1px solid #334155;background:#0b1224;cursor:pointer}
.btn-back{display:inline-block;text-decoration:none;font-weight:800;background:#0b1224;color:#e5e7eb;border:1px solid #334155;padding:10px 12px;border-radius:12px}
.btn-back:active{transform:translateY(1px)}
.btn-icon{display:inline-grid;place-items:center;width:44px;height:44px;padding:0;border-radius:12px}
.kids.panel{display:flex;gap:12px;align-items:center;overflow:auto}
.kid{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card);border:1px solid #1f2937;border-radius:14px;min-width:210px;user-select:none}
.kid[aria-selected="true"]{outline:2px solid var(--accent)}
.face{width:56px;height:56px;border-radius:50%;background:#0b1224;display:grid;place-items:center;font-size:28px;border:2px solid #334155;overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
.choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
@media(min-width:900px){.choices{grid-template-columns:repeat(4,minmax(0,1fr))}}
.choice{background:var(--panel);border:1px solid #1f2937;border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;gap:12px;min-height:210px}
.food-head{display:flex;align-items:center;gap:10px}
.food-emoji{font-size:36px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
.avatars{display:flex;flex-wrap:wrap;gap:8px;min-height:44px}
.avatar{width:40px;height:40px;border-radius:50%;background:#0b1224;display:grid;place-items:center;font-size:20px;border:2px solid #334155}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.empty-hint{margin-top:auto;font-size:.9rem;color:var(--muted)}
.summary.panel{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
@media(min-width:760px){.summary.panel{grid-template-columns:repeat(2,minmax(0,1fr))}}
.summary-item{display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid #1f2937;padding:10px 12px;border-radius:12px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid #334155;font-weight:700}
.pill .emoji{font-size:18px}
.footer{text-align:center;opacity:.7;font-size:.85rem}
.version{opacity:.6;font-size:.8rem;margin-top:6px}
/* hide hidden file input */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <div style="font-size:1.6rem">Breakfast Chooser</div>
        <div class="small">Tap a child, then tap a food card to choose.</div>
      </div>
      <div class="controls">
        <label class="sr-only" for="theDate">Date</label>
        <input id="theDate" type="date"/>
        <a href="./index.html" class="btn-back" title="Back to Home">‚Üê Home</a>
        <button id="btnClear" class="btn-ghost">Reset</button>
        <button id="btnRandomize" class="btn-ghost">Random</button>
        <button id="btnShare" class="btn-primary btn-icon" title="Copy Summary" aria-label="Copy Summary">üìã</button>
        <button id="btnAdmin" class="icon-btn" title="Admin">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="kids panel" id="kidsRow"></section>
    <section class="choices" id="choicesGrid"></section>
    <section class="summary panel" id="summary"></section>

    <div class="footer">
      Works offline. Data stays on this device (local only).
      <div class="version">Breakfast v3.3.1</div>
    </div>
  </div>

  <input type="file" id="file-picker" accept="image/*" class="sr-only"/>

<!-- Family Store -->
<script src="family.js"></script>

<script>
// ---------- Utils ----------
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const LS={ menu:'bc:menu:all', active:'bc:menu:active', day:d=>`bc:choices:${d}` };
const uid=()=>Math.random().toString(36).slice(2,10);
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{ return f;}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const today=()=>new Date().toISOString().slice(0,10);
const initials=n=>((n||'?').trim()[0]||'?').toUpperCase();

// ---------- Defaults ----------
const DEFAULT_MENU=[
  {id:uid(),emoji:'üßá',label:'Waffles'},
  {id:uid(),emoji:'üçì',label:'Pop-Tart'},
  {id:uid(),emoji:'ü•£',label:'Cereal'},
  {id:uid(),emoji:'ü•Ø',label:'Bagel & Cream Cheese'}
];
function ensureSeed(){
  let menu=load(LS.menu,null); if(!Array.isArray(menu)||!menu.length){menu=DEFAULT_MENU; save(LS.menu,menu);}
  let act=load(LS.active,null); if(!Array.isArray(act)||!act.length){act=menu.slice(0,4).map(m=>m.id); save(LS.active,act);}
}

// ---------- Accessors ----------
function getAllMenu(){return load(LS.menu,DEFAULT_MENU)}
function getActive(){return load(LS.active,[])}
function setDay(d,o){save(LS.day(d),o)}
function getDay(d){return load(LS.day(d),{})}

// Safe kids accessor (works even if Family.js failed)
function getKidsSafe(){
  try{
    if (window.Family && typeof Family.getActiveKids==='function') {
      const k=Family.getActiveKids();
      if (Array.isArray(k) && k.length) return k;
    }
  }catch(e){ console.warn('Family store unavailable, using fallback', e); }
  // Fallback seed (names only)
  return [
    {id:'k1',name:'Emilia',photo:null},
    {id:'k2',name:'Hudson',photo:null},
    {id:'k3',name:'Penelope',photo:null},
    {id:'k4',name:'Jasper',photo:null},
  ];
}

// ---------- Rendering ----------
let activeKid=null;

function renderKids(){
  const row=$('#kidsRow'); row.innerHTML='';
  getKidsSafe().forEach(k=>{
    const el=document.createElement('div');
    el.className='kid'; el.dataset.kid=k.id;
    el.setAttribute('aria-selected',activeKid===k.id?'true':'false');
    el.innerHTML=`<div class="face">${k.photo?`<img src="${k.photo}">`:`<span>${initials(k.name)}</span>`}</div><div><div style="font-weight:800">${k.name}</div></div>`;
    row.appendChild(el);
  });
}
function renderChoices(){
  const grid=$('#choicesGrid'); grid.innerHTML='';
  const date=$('#theDate').value; const picks=getDay(date);
  const all=getAllMenu(); const actIds=load(LS.active,[]);
  all.filter(m=>actIds.includes(m.id)).forEach(c=>{
    const card=document.createElement('div'); card.className='choice'; card.dataset.choice=c.id;
    card.innerHTML=`<div class="food-head"><div class="food-emoji">${c.emoji}</div><div class="food-name">${c.label}</div></div><div class="avatars"></div><div class="empty-hint">Tap to select</div>`;
    const wrap=card.querySelector('.avatars');
    getKidsSafe().forEach(k=>{
      if(picks[k.id]===c.id){
        wrap.innerHTML+=`<div class="avatar">${k.photo?`<img src="${k.photo}">`:`<span>${initials(k.name)}</span>`}</div>`;
      }
    });
    if(wrap.children.length) card.querySelector('.empty-hint').style.display='none';
    grid.appendChild(card);
  });
}
function renderSummary(){
  const s=$('#summary'); s.innerHTML='';
  const date=$('#theDate').value; const picks=getDay(date); const all=getAllMenu();
  getKidsSafe().forEach(k=>{
    const ch=all.find(c=>c.id===picks[k.id]);
    s.innerHTML+=`<div class="summary-item"><div style="display:flex;align-items:center;gap:10px"><div class="face" style="width:42px;height:42px">${k.photo?`<img src="${k.photo}">`:`<span>${initials(k.name)}</span>`}</div><div>${k.name}</div></div>${ch?`<div class="pill"><span class="emoji">${ch.emoji}</span> ${ch.label}</div>`:`<div class="pill" style="opacity:.6">Not chosen</div>`}</div>`;
  });
}
function renderAll(){renderKids();renderChoices();renderSummary();attachInteractions();}

// ---------- Interactions ----------
function attachInteractions(){
  $$('#kidsRow .kid').forEach(k=>{
    k.onclick=()=>{activeKid=k.dataset.kid; renderKids();}
  });
  $$('#choicesGrid .choice').forEach(c=>{
    c.onclick=()=>{if(!activeKid)return; const d=$('#theDate').value; const picks=getDay(d); picks[activeKid]=c.dataset.choice; setDay(d,picks); renderAll();}
  });
}

// ---------- Controls ----------
function bindControls(){
  $('#theDate').value=today();
  $('#btnClear').onclick=()=>{localStorage.removeItem(LS.day($('#theDate').value)); renderAll();}
  $('#btnRandomize').onclick=()=>{const d=$('#theDate').value;const picks={};const act=getActive();getKidsSafe().forEach(k=>{picks[k.id]=act[Math.floor(Math.random()*act.length)]});setDay(d,picks);renderAll();}
  $('#btnShare').onclick=async()=>{const d=$('#theDate').value;const picks=getDay(d);const all=getAllMenu();const lines=getKidsSafe().map(k=>{const ch=all.find(c=>c.id===picks[k.id]);return `${k.name}: ${ch?`${ch.emoji} ${ch.label}`:'‚Äî'}`});const txt=`Breakfast ${d}\n`+lines.join('\n');try{await navigator.clipboard.writeText(txt);alert('Copied!');}catch{prompt('Copy manually:',txt)}}
}

// ---------- Boot ----------
ensureSeed();
bindControls();
renderAll();
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
</script>
</body>
</html>
