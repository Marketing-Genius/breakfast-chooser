<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam ¬∑ Breakfast Chooser</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text); background:linear-gradient(180deg,#0b1026 0%,#0f172a 100%);
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
}
.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:18px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid #111827;box-shadow:var(--shadow);border-radius:18px;padding:14px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:800}
.title .small{font-weight:600;font-size:.85rem;color:var(--muted)}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px 12px;color:var(--text);font:inherit;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);border:none;color:#001018;font-weight:800}
.btn-ghost{background:transparent;border:1px dashed #334155;color:var(--muted)}
.btn-icon{display:grid;place-items:center;width:44px;height:44px;border-radius:12px;border:1px solid #334155;background:#0b1224}
.btn-back{display:inline-block;text-decoration:none;font-weight:800;background:#0b1224;color:#e5e7eb;border:1px solid #334155;padding:10px 12px;border-radius:12px}
.small{font-size:.9rem}
.hint{opacity:.8;font-size:.9rem;text-align:center}
.version{opacity:.6;font-size:.8rem;margin-top:6px}

/* Kids row */
.kids{display:flex;gap:10px;flex-wrap:wrap}
.kid{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid #374151;border-radius:14px;padding:8px 12px}
.kid[data-active="true"]{outline:2px solid var(--accent)}
.avatar{width:36px;height:36px;border-radius:50%;background:#0b1224;border:1px solid #334155;object-fit:cover;display:grid;place-items:center;font-weight:800}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid #334155;color:#cbd5e1}

/* Choices grid */
.grid{display:grid;gap:14px}
@media(min-width:780px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px;display:grid;gap:12px}
.card .head{display:flex;align-items:center;justify-content:space-between}
.food{font-size:1.2rem;font-weight:800}
.picks{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:flex;align-items:center;gap:8px;background:#1f2937;border:1px solid #111827;border-radius:999px;padding:6px 10px}
.pill img{width:20px;height:20px;border-radius:50%;object-fit:cover;border:1px solid #334155}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(720px,100%);max-height:90vh;display:flex;flex-direction:column;
       background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:inherit}
.modal .body{padding:14px 16px;display:grid;gap:16px;overflow:auto;max-height:70vh}
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px}
.list{display:grid;gap:10px}
.item{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;background:#1f2937;border:1px solid #111827;border-radius:12px;padding:10px}
input[type="text"]{background:var(--card);border:1px solid #374151;border-radius:12px;padding:10px 12px;color:var(--text);font:inherit}
</style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <div style="font-size:1.6rem">Breakfast Chooser</div>
        <div class="small">Tap a child, then tap a food card to choose.</div>
      </div>
      <div class="controls">
        <a href="./index.html" class="btn-back">‚Üê Home</a>

        <label class="badge" for="theDate">Date</label>
        <input id="theDate" class="btn" type="date"/>

        <button id="btnReset" class="btn">Reset</button>
        <button id="btnRandom" class="btn-icon" title="Randomize">üé≤</button>

        <button id="btnCopy" class="btn-icon" title="Copy summary">üìã</button>
        <button id="btnShare" class="btn-icon" title="Share‚Ä¶">üì§</button>

        <button id="btnMenu" class="btn">Menu</button>
        <button id="btnAdmin" class="btn-icon" title="Admin">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="panel">
      <div class="kids" id="kidsRow"></div>
    </section>

    <section class="grid" id="choicesGrid"></section>

    <div class="hint">
      Works offline. Data stays on this device (local only).
      <div class="version">Breakfast v3.5</div>
    </div>
  </div>

  <!-- Menu Modal -->
  <div class="modal-backdrop" id="menuModal" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">
    <div class="modal">
      <header>
        <div id="menuTitle" style="font-weight:800">Breakfast Menu</div>
        <button id="menuClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div class="badge">Edit the 4 choices (emoji + name)</div>
        <div id="menuList" class="list"></div>
      </div>
      <div class="footer">
        <button id="menuDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Family store -->
  <script src="family.js?v=3.3.6"></script>
  <script>
  // Minimal shim if family.js unavailable (reads kids from 'hub:family:kids')
  if(!window.Family){
    (function(){
      const K={kids:'hub:family:kids', pin:'hub:family:pin'};
      const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
      window.Family={
        getKids(){ return load(K.kids,[]); },
        verifyPin(p){ const real=load(K.pin,null); return real?String(real)===String(p):true; },
        onChange(){ return ()=>{}; }
      };
    })();
  }
  </script>

  <script>
  /* ---------------- Keys & helpers ---------------- */
  const LS = {
    menu:'bf:menu',              // [{emoji,label}] length 4
    day:(iso)=>`bf:day:${iso}`   // {kidId: {emoji,label}}
  };
  const $=(s,e=document)=>e.querySelector(s);
  const $$=(s,e=document)=>[...e.querySelectorAll(s)];
  const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

  function todayISO(){ const d=$('#theDate').value ? new Date($('#theDate').value) : new Date(); const off=d.getTimezoneOffset(); d=new Date(d.getTime()-off*60000); return d.toISOString().slice(0,10); }

  function seedMenu(){
    let m=load(LS.menu,null);
    if(!m || m.length!==4){
      m=[ {emoji:'üßá',label:'Waffles (Eggo)'},
          {emoji:'ü•ß',label:'Pop-Tart'},
          {emoji:'ü•£',label:'Cereal'},
          {emoji:'ü•Ø',label:'Bagel & Cream Cheese'} ];
      save(LS.menu,m);
    }
  }

  /* ---------------- Share helper ---------------- */
  async function shareText(content){
    try{
      if(navigator.share){ await navigator.share({text:content}); return; }
    }catch{}
    const encoded=encodeURIComponent(content);
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
    const href=isIOS?`sms:&body=${encoded}`:`sms:?body=${encoded}`;
    try{ location.href=href; return; }catch{}
    try{ await navigator.clipboard.writeText(content); alert('Copied to clipboard.'); }
    catch{ alert('Share unavailable. Copy/paste this:\n\n'+content); }
  }

  /* ---------------- Render ---------------- */
  let activeKidId=null;

  function renderKids(){
    const wrap=$('#kidsRow'); wrap.innerHTML='';
    const kids=(Family.getKids&&Family.getKids())||[];
    if(!kids.length){ wrap.innerHTML='<span class="small" style="color:#cbd5e1">No kids yet. Add them in Home ‚Üí Admin Settings.</span>'; return; }
    kids.forEach(k=>{
      const el=document.createElement('button'); el.className='kid'; el.dataset.active=activeKidId===k.id;
      el.innerHTML=`<img class="avatar" ${k.photo?`src="${k.photo}"`:`alt="${k.name[0]||'K'}"`} />
                    <span>${k.name}</span>`;
      if(!k.photo){ el.querySelector('.avatar').textContent=(k.name||'?').slice(0,1).toUpperCase(); }
      el.onclick=()=>{ activeKidId=(activeKidId===k.id? null : k.id); renderKids(); };
      wrap.appendChild(el);
    });
  }

  function renderChoices(){
    const grid=$('#choicesGrid'); grid.innerHTML='';
    const menu=load(LS.menu,[]);
    const map=load(LS.day(todayISO()),{});
    const kids=(Family.getKids&&Family.getKids())||[];

    menu.forEach((opt,idx)=>{
      const el=document.createElement('div'); el.className='card';
      el.innerHTML=`
        <div class="head">
          <div class="food">${opt.emoji} ${opt.label}</div>
          <button class="btn" data-choose="${idx}">Choose</button>
        </div>
        <div class="picks" id="picks-${idx}"></div>
      `;
      grid.appendChild(el);
    });

    // fill picks (only show faces that chose it; otherwise empty)
    menu.forEach((_,idx)=>{
      const row=$(`#picks-${idx}`);
      Object.entries(map).forEach(([kidId,choiceIdx])=>{
        if(Number(choiceIdx)===idx){
          const kid=kids.find(k=>String(k.id)===String(kidId));
          if(!kid) return;
          const pill=document.createElement('div'); pill.className='pill';
          pill.innerHTML = kid.photo
            ? `<img src="${kid.photo}" alt=""> <span>${kid.name}</span>`
            : `<span class="avatar" style="width:20px;height:20px;border-radius:50%;display:grid;place-items:center;font-size:.75rem">${(kid.name||'?').slice(0,1)}</span><span>${kid.name}</span>`;
          row.appendChild(pill);
        }
      });
    });

    // choose handlers
    $$('[data-choose]').forEach(btn=>{
      btn.onclick=()=>{
        if(!activeKidId){ alert('Tap a child first.'); return; }
        const idx=Number(btn.dataset.choose);
        const map=load(LS.day(todayISO()),{});
        map[activeKidId]=idx;
        save(LS.day(todayISO()),map);
        renderChoices();
      };
    });
  }

  function buildSummary(){
    const dateTxt = new Date($('#theDate').value||Date.now()).toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});
    const menu=load(LS.menu,[]);
    const map=load(LS.day(todayISO()),{});
    const kids=(Family.getKids&&Family.getKids())||[];
    const lines=[`üç≥ Fambam Breakfast ‚Äî ${dateTxt}`];
    kids.forEach(k=>{
      const c = map[k.id]; const food = (c!=null? `${menu[c].emoji} ${menu[c].label}` : '‚Äî');
      lines.push(`${k.name}: ${food}`);
    });
    return lines.join('\n');
  }

  /* ---------------- Menu modal ---------------- */
  const menuModal=$('#menuModal');
  const closeMenu=()=>{menuModal.style.display='none';menuModal.setAttribute('aria-hidden','true');};
  const openMenu=()=>{buildMenuList();menuModal.style.display='flex';menuModal.setAttribute('aria-hidden','false');};

  $('#menuClose').onclick=closeMenu;
  $('#menuDone').onclick=closeMenu;

  function buildMenuList(){
    const list=$('#menuList'); list.innerHTML='';
    const menu=load(LS.menu,[]);
    menu.forEach((m,idx)=>{
      const row=document.createElement('div'); row.className='item';
      row.innerHTML=`
        <input data-emo type="text" value="${m.emoji||''}" placeholder="üç≥" style="width:100px;text-align:center"/>
        <input data-label type="text" value="${m.label||''}" placeholder="Item name (e.g., Waffles)"/>
        <button class="btn" data-save>Save</button>`;
      list.appendChild(row);
      row.querySelector('[data-save]').onclick=()=>{
        menu[idx]={ emoji: row.querySelector('[data-emo]').value||'üç≥', label: row.querySelector('[data-label]').value||'Item' };
        save(LS.menu,menu); renderChoices();
      };
    });
  }

  /* ---------------- Buttons ---------------- */
  $('#btnMenu').onclick=openMenu;

  // Reset clears today only
  $('#btnReset').onclick=()=>{ if(confirm('Clear choices for this date?')){ localStorage.removeItem(LS.day(todayISO())); renderChoices(); } };

  // Random: assign random choices to all kids
  $('#btnRandom').onclick=()=>{
    const kids=(Family.getKids&&Family.getKids())||[];
    if(!kids.length) return;
    const menu=load(LS.menu,[]);
    const map={};
    kids.forEach(k=>{ map[k.id]=Math.floor(Math.random()*menu.length); });
    save(LS.day(todayISO()),map); renderChoices();
  };

  // Copy + Share
  $('#btnCopy').onclick=()=>{ const t=buildSummary(); navigator.clipboard.writeText(t).then(()=>alert('Summary copied.')); };
  $('#btnShare').onclick=()=> shareText(buildSummary());

  // Admin gear: route to Home admin
  $('#btnAdmin').onclick=()=>location.href='./index.html#admin';

  // Date
  (function initDate(){
    const d=new Date(); const off=d.getTimezoneOffset(); const local=new Date(d.getTime()-off*60000);
    $('#theDate').value=local.toISOString().slice(0,10);
    $('#theDate').onchange=()=>renderChoices();
  })();

  /* ---------------- Boot ---------------- */
  seedMenu();
  renderKids();
  renderChoices();

  if('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
  </script>
</body>
</html>
