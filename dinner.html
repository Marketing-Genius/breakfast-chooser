<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam ¬∑ Dinner Planner</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text); background:linear-gradient(180deg,#0b1026 0%,#0f172a 100%);
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
}
.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:18px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid #111827;box-shadow:var(--shadow);border-radius:var(--radius);padding:14px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:800;letter-spacing:.2px}
.title .small{font-weight:600;font-size:.85rem;color:var(--muted)}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
input,button,select{font:inherit;color:var(--text)}
select, input[type="text"], textarea{background:var(--card);border:1px solid #374151;border-radius:12px;padding:10px 12px;min-width:140px;color:var(--text)}
textarea{min-height:88px;resize:vertical}
button{cursor:pointer}
.btn{background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px 12px}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#001018;border:none;font-weight:800}
.btn-ghost{background:transparent;border:1px dashed #334155;color:var(--muted)}
.btn-warn{background:#3f1620;border:1px solid #7f1d1d;color:#fecaca}
.btn-icon{display:grid;place-items:center;width:44px;height:44px;border-radius:12px;border:1px solid #334155;background:#0b1224}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1224;border:1px solid #334155;color:#cbd5e1}
.menu{position:relative}
.menu-btn{min-width:110px}
.menu-dd{position:absolute;right:0;top:110%;background:#111827;border:1px solid #1f2937;border-radius:12px;box-shadow:var(--shadow);display:none;padding:6px;z-index:10}
.menu-dd.open{display:block}
.menu-dd .mi{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:#e5e7eb;border-radius:10px}
.menu-dd .mi:hover{background:#0b1224}

.grid{display:grid;gap:14px}
@media(min-width:860px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.card{display:grid;gap:12px;background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:14px}
.card .head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.card .head .right{display:flex;gap:8px;align-items:center}
.day{font-weight:800}
.row{display:grid;gap:8px;grid-template-columns:92px 1fr 1fr}
.row .label{color:#cbd5e1;align-self:center}
.row .actions{display:flex;gap:8px;align-items:center}
.add-line{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.hint{opacity:.8;font-size:.9rem;text-align:center}
.version{opacity:.6;font-size:.8rem;margin-top:6px}

/* Modal (scroll-safe) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);max-height:90vh;display:flex;flex-direction:column;
       background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:inherit;z-index:1}
.modal .body{padding:14px 16px;display:grid;gap:16px;overflow:auto;max-height:70vh}
@supports (-webkit-touch-callout: none) { .modal .body{ -webkit-overflow-scrolling: touch; } }
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px;position:sticky;bottom:0;background:inherit}

/* Lists in Manage */
.list{display:grid;gap:10px}
.item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:#1f2937;border:1px solid #111827;border-radius:12px;padding:10px}

/* Notes badges */
.btn-badge{position:relative}
.btn-badge[data-hasnotes="true"]::after{
  content:""; position:absolute; right:8px; top:8px; width:8px; height:8px; border-radius:50%;
  background:#22d3ee; box-shadow:0 0 0 2px rgba(11,18,36,.8);
}

.pin-input{font:inherit;color:var(--text);background:var(--card);border:1px solid #374151;border-radius:12px;padding:14px 16px;letter-spacing:2px;text-align:center}
.smallmuted{color:#94a3b8;font-size:.9rem}
.noteRow{display:flex;align-items:center;justify-content:space-between;background:#1f2937;border:1px solid #111827;border-radius:12px;padding:10px}
</style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="title">
        <div style="font-size:1.6rem">Dinner Planner</div>
        <div class="small">Plan dinners for the week. Templates, groceries & sharing included.</div>
      </div>
      <div class="controls">
        <a href="./index.html" class="btn">‚Üê Home</a>
        <button id="btnTemplates" class="btn">Templates</button>
        <button id="btnPizzaFri" class="btn-ghost" title="Auto-fill üçï on Fridays">üçï Pizza Fri: <span id="pizzaState">off</span></button>
        <button id="btnManage" class="btn-primary">Manage</button>
        <button id="btnGroceries" class="btn">Groceries</button>

        <!-- Share dropdown -->
        <div class="menu">
          <button id="btnShare" class="btn menu-btn">Share ‚ñæ</button>
          <div id="shareDD" class="menu-dd" role="menu" aria-hidden="true">
            <button class="mi" data-share="gro">Groceries (share)</button>
            <button class="mi" data-share="plan">Plan (share)</button>
            <button class="mi" data-share="copy">Copy Summary</button>
          </div>
        </div>

        <button id="btnReset"  class="btn">Reset Week</button>
        <button id="btnAdmin"  class="btn-icon" title="Admin">‚öôÔ∏è</button>
      </div>
    </header>

    <section class="panel" id="weekPanel">
      <div>Week of <b id="weekLabel"></b></div>
    </section>

    <section class="grid" id="cards"></section>

    <div class="hint">
      Works offline. Data stays on this device (local only).
      <div class="version">Dinner Planner v1.3.1 (notes + share menu + rating default)</div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div class="modal-backdrop" id="manageModal" aria-hidden="true" role="dialog" aria-labelledby="manageTitle">
    <div class="modal">
      <header>
        <div id="manageTitle" style="font-weight:800">Manage Menus</div>
        <button id="manageClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div class="badge">Food Options (for Main & Side)</div>
        <div id="foodList" class="list"></div>
        <div class="add-line">
          <input id="newFood" type="text" placeholder="Add food (e.g., üçï Pizza)"/>
          <button id="addFood" class="btn-primary">Add</button>
        </div>

        <div class="badge">Dessert Options</div>
        <div id="dessertList" class="list"></div>
        <div class="add-line">
          <input id="newDessert" type="text" placeholder="Add dessert (e.g., üç® Ice Cream)"/>
          <button id="addDessert" class="btn-primary">Add</button>
        </div>

        <div class="badge">Pantry / Staples (excluded from grocery list)</div>
        <textarea id="pantryBox" placeholder="e.g., salt, pepper, ketchup, olive oil"></textarea>
      </div>
      <div class="footer">
        <button id="manageSave" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-backdrop" id="tplModal" aria-hidden="true" role="dialog" aria-labelledby="tplTitle">
    <div class="modal">
      <header>
        <div id="tplTitle" style="font-weight:800">Templates</div>
        <button id="tplClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div class="badge">Built-ins</div>
        <div class="list" id="tplBuiltins"></div>
        <div class="badge">Your Templates</div>
        <div class="list" id="tplUser"></div>
        <div class="add-line">
          <input id="tplName" type="text" placeholder="Template name (e.g., Week: Pizza Friday)"/>
          <button id="tplSave" class="btn-primary">Save Current as Template</button>
        </div>
      </div>
      <div class="footer">
        <button id="tplApplyDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Groceries Modal -->
  <div class="modal-backdrop" id="groModal" aria-hidden="true" role="dialog" aria-labelledby="groTitle">
    <div class="modal">
      <header>
        <div id="groTitle" style="font-weight:800">Grocery List</div>
        <button id="groClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="groBody"></div>
      <div class="footer">
        <button id="groCopy" class="btn">Copy</button>
        <button id="groDownload" class="btn-primary">Download .txt</button>
      </div>
    </div>
  </div>

  <!-- Day Notes Modal -->
  <div class="modal-backdrop" id="dayNotesModal" aria-hidden="true" role="dialog" aria-labelledby="dayNotesTitle">
    <div class="modal">
      <header>
        <div id="dayNotesTitle" style="font-weight:800">Food Notes</div>
        <button id="dayNotesClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="dayNotesBody"></div>
      <div class="footer">
        <button id="dayNotesDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Food Notes Editor Modal (global only) -->
  <div class="modal-backdrop" id="notesEditModal" aria-hidden="true" role="dialog" aria-labelledby="notesEditTitle">
    <div class="modal">
      <header>
        <div id="notesEditTitle" style="font-weight:800">Edit Notes</div>
        <button id="notesEditClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div class="badge">Item</div>
        <div id="fnLabel" class="smallmuted"></div>

        <div class="badge">Global notes</div>
        <textarea id="fnGlobal"></textarea>
      </div>
      <div class="footer" style="justify-content:space-between">
        <button id="fnClear" class="btn-warn">Clear Notes</button>
        <div>
          <button id="fnSave" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal-backdrop" id="pinModal" aria-hidden="true" role="dialog" aria-labelledby="pinTitle">
    <div class="modal" style="max-width:420px">
      <header>
        <div id="pinTitle" style="font-weight:800">Enter Admin PIN</div>
        <button id="pinClose" class="btn">‚úñ</button>
      </header>
      <div class="body" style="gap:12px">
        <input id="pinInputModal" class="pin-input" inputmode="numeric" pattern="\\d*" placeholder="PIN (numbers only)" autofocus />
      </div>
      <div class="footer">
        <button id="pinOk" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Family store -->
  <script src="family.js?v=3.3.6"></script>

  <script>
  // Share helper (native share ‚Üí SMS deeplink ‚Üí clipboard)
  async function shareText(content){
    try{ if(navigator.share){ await navigator.share({text:content}); return; } }catch{}
    const encoded=encodeURIComponent(content);
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
    const href=isIOS?`sms:&body=${encoded}`:`sms:?body=${encoded}`;
    try{ location.href=href; return; }catch{}
    try{ await navigator.clipboard.writeText(content); alert('Copied to clipboard.'); }
    catch{ alert('Share unavailable. Copy/paste this:\n\n'+content); }
  }
  </script>

  <script>
/* ---------- Base storage/seed ---------- */
const LS={foods:'dp:foods:list',desserts:'dp:desserts:list',week:(m)=>`dp:plan:${m}`,templates:'dp:tpls',pantry:'dp:pantry',pizzaFri:'dp:pizzaFri', notes:'dp:food:notes'};
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,10);
function startOfWeekMonday(d=new Date()){const dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const day=(dt.getUTCDay()+6)%7;dt.setUTCDate(dt.getUTCDate()-day);return dt;}
function isoDateUTC(d){return d.toISOString().slice(0,10)} function thisMondayISO(){return isoDateUTC(startOfWeekMonday(new Date()))}
function weekLabelText(mISO){const m=new Date(mISO+'T00:00:00Z');const e=new Date(m);e.setUTCDate(e.getUTCDate()+6);const f=d=>d.toLocaleDateString(undefined,{month:'short',day:'numeric'});return `${f(m)} ‚Äì ${f(e)}`}
function seedFoodsIfNeeded(){let foods=load(LS.foods,null);if(!Array.isArray(foods)||foods.length<10){foods=["üçï Pizza","üåÆ Tacos","üçù Spaghetti","üçó Chicken Nuggets","ü•™ Sandwiches","üå≠ Hot Dogs","üçî Burgers","ü•ó Caesar Salad","üçõ Curry & Rice","ü•ü Potstickers","üç§ Shrimp Stir-Fry","ü•û Breakfast for Dinner","ü•î Baked Potatoes","üç£ Sushi Night","üåØ Burritos","ü•ò Chili","üçú Ramen","ü•ô Pita & Hummus","üçñ BBQ Chicken","ü•¶ Veggie Stir-Fry","üßÜ Meatballs","ü•© Steak & Veg","ü•ß Pot Pie","üçö Fried Rice","üßÄ Mac & Cheese","üêü Baked Fish","ü•ö Omelets","üç≤ Chicken Noodle Soup","ü•í Snack Plate","ü•¨ Tacos (Veggie)","üåÆ Taco Salad","üåØ Quesadillas","üçù Penne & Marinara","ü•ó Greek Salad","üçñ Pulled Pork","üçó Roasted Chicken","üçù Alfredo Pasta","ü•™ BLT","üå∂Ô∏è Fajitas","üçñ Ribs","üçù Lasagna","ü•ó Cobb Salad","üçõ Butter Chicken","ü•ò Paella","üçö Teriyaki Bowls","üç† Sweet Potatoes","ü•® Pretzel Dogs","ü•™ Grilled Cheese","üç§ Popcorn Shrimp","üçï Flatbreads"];save(LS.foods,foods)}let desserts=load(LS.desserts,null);if(!Array.isArray(desserts)||desserts.length<3){desserts=["üç™ Cookies","üç® Ice Cream","üç∞ Cake","üçì Berries & Cream","ü•ß Pie","üç´ Brownies","üçÆ Pudding","üçé Apple Slices & PB"];save(LS.desserts,desserts)}if(load(LS.pantry,null)==null){save(LS.pantry,["salt","pepper","ketchup","mustard","olive oil","butter"])}if(load(LS.pizzaFri,null)==null){save(LS.pizzaFri,false)}}

/* ---------- Plan model ---------- */
const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function emptyDay(){return {kids:{main:"",side:""},parents:{main:"",side:""},dessert:"",rating:null}}  /* rating default = blank */
function loadWeekPlan(mISO){let plan=load(LS.week(mISO),null);if(!plan){plan={days:{}};DAYS.forEach(d=>plan.days[d]=emptyDay());save(LS.week(mISO),plan)}if(load(LS.pizzaFri,false)){const fri=plan.days["Fri"];if(fri&&!fri.kids.main&&!fri.parents.main){fri.kids.main="üçï Pizza";fri.parents.main="üçï Pizza";save(LS.week(mISO),plan)}}return plan}
function saveWeekPlan(mISO,plan){save(LS.week(mISO),plan)}

/* ---------- Food Notes store ---------- */
function getNotes(){ return load(LS.notes, {}); }
function setNotes(map){ save(LS.notes, map); }

/* ---------- Render ---------- */
function render(){
  const mISO=thisMondayISO();
  $('#weekLabel').textContent=weekLabelText(mISO);
  const plan=loadWeekPlan(mISO);
  const foods=load(LS.foods,[]),desserts=load(LS.desserts,[]);
  const cards=$('#cards'); cards.innerHTML='';

  DAYS.forEach((day,i)=>{
    const data=plan.days[day]||emptyDay();
    const dt=new Date(mISO+'T00:00:00Z'); dt.setUTCDate(dt.getUTCDate()+i);
    const nice=dt.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});

    const el=document.createElement('div'); el.className='card'; el.dataset.day=day;

    // rating dropdown (blank default)
    const rateSel = `
      <select data-rate="${day}" title="How did dinner go?">
        <option value="" ${data.rating==null?'selected':''}>‚Äî rating ‚Äî</option>
        <option value="1" ${data.rating===1?'selected':''}>üëç</option>
        <option value="0" ${data.rating===0?'selected':''}>üòê</option>
        <option value="-1" ${data.rating===-1?'selected':''}>üëé</option>
      </select>`;

    // notes button + indicator
    const hasAnyNotes = dayHasAnyNotes(data);
    const notesBtn = `<button class="btn btn-badge" data-notes="${day}" ${hasAnyNotes?'data-hasnotes="true"':''}>Notes</button>`;

    el.innerHTML = `
      <div class="head">
        <div class="day">${day}</div>
        <div class="right">
          <span class="badge">${nice}</span>
          ${rateSel}
          ${notesBtn}
        </div>
      </div>

      <div class="row">
        <div class="label">Kids</div>
        <select data-k="${day}" data-field="kids.main">${options(foods,data.kids.main)}</select>
        <select data-k="${day}" data-field="kids.side">${options(foods,data.kids.side)}</select>
      </div>
      <div class="row">
        <div class="label">Parents</div>
        <select data-k="${day}" data-field="parents.main">${options(foods,data.parents.main)}</select>
        <select data-k="${day}" data-field="parents.side">${options(foods,data.parents.side)}</select>
      </div>
      <div class="row">
        <div class="label">Dessert</div>
        <div class="actions">
          <select data-k="${day}" data-field="dessert" ${data.dessert?'':'style="display:none"'}>${options(desserts,data.dessert,true)}</select>
          <button class="btn" data-dess="${day}">${data.dessert?'Remove dessert':'Add dessert'}</button>
        </div>
      </div>
    `;
    cards.appendChild(el);
  });

  // selects change
  $$('#cards select[data-k]').forEach(sel=>{
    sel.onchange=()=>{const day=sel.dataset.k,field=sel.dataset.field;const plan=loadWeekPlan(thisMondayISO());setByPath(plan.days[day],field,sel.value);saveWeekPlan(thisMondayISO(),plan); updateNotesBadgesFor(day);};
  });

  // dessert toggle
  $$('[data-dess]').forEach(btn=>{
    btn.onclick=()=>{
      const day=btn.dataset.dess;
      const plan=loadWeekPlan(thisMondayISO());
      const row=btn.closest('.row'); const sel=row.querySelector('select');
      if(plan.days[day].dessert){ plan.days[day].dessert=""; sel.style.display='none'; btn.textContent='Add dessert'; }
      else { plan.days[day].dessert=""; sel.style.display=''; btn.textContent='Remove dessert'; }
      saveWeekPlan(thisMondayISO(),plan); updateNotesBadgesFor(day);
    };
  });

  // rating save
  $$('select[data-rate]').forEach(r=>{
    r.onchange=()=>{
      const day=r.dataset.rate;
      const plan=loadWeekPlan(thisMondayISO());
      plan.days[day].rating = (r.value===''? null : parseInt(r.value,10));
      saveWeekPlan(thisMondayISO(),plan);
    };
  });

  // notes per day
  $$('[data-notes]').forEach(b=>{
    b.onclick=()=> openDayNotes(b.dataset.notes);
  });

  $('#pizzaState').textContent=load(LS.pizzaFri,false)?'on':'off';
}

function options(list,selected,allowBlank=false){
  const placeholder='‚Äî Choose item ‚Äî';
  const arr=allowBlank?[placeholder,...list]:[placeholder,...list];
  return arr.map(v=>{
    const isPH=v===placeholder; const val=isPH?'':v;
    const sel=(val===selected)||(isPH&&!selected)?' selected':'';
    return `<option value="${escapeHtml(val)}"${sel}>${escapeHtml(v)}</option>`;
  }).join('');
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function setByPath(o,p,val){const parts=p.split('.');for(let i=0;i<parts.length-1;i++)o=o[parts[i]];o[parts[parts.length-1]]=val}

/* ---------- Manage modal ---------- */
const manageModal=$('#manageModal');$('#manageClose').onclick=()=>hide(manageModal);$('#manageSave').onclick=()=>{const list=($('#pantryBox').value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);save(LS.pantry,list);hide(manageModal);}
$('#btnManage').onclick=()=>{const hasPin=(localStorage.getItem('hub:family:pin')??'null')!=='null';if(hasPin)requestPinUI(()=>setTimeout(openManage,0));else openManage();};
function openManage(){buildFoodList();buildDessertList();$('#pantryBox').value=load(LS.pantry,[]).join(', ');show(manageModal);}
function buildFoodList(){const wrap=$('#foodList');wrap.innerHTML='';const foods=load(LS.foods,[]);foods.forEach((f,idx)=>{const row=document.createElement('div');row.className='item';row.innerHTML=`<input class="btn" value="${escapeHtml(f)}"/><div style="display:flex;gap:8px"><button class="btn" data-notes>üìù Notes</button><button class="btn-warn" data-rm>Remove</button></div>`;wrap.appendChild(row);row.querySelector('[data-notes]').onclick=()=>openNotesEditor(f);row.querySelector('input').oninput=e=>{foods[idx]=e.target.value;save(LS.foods,foods);render();};row.querySelector('[data-rm]').onclick=()=>{foods.splice(idx,1);save(LS.foods,foods);buildFoodList();render();};});$('#addFood').onclick=()=>{const v=($('#newFood').value||'').trim();if(!v)return;const list=load(LS.foods,[]);list.push(v);save(LS.foods,list);$('#newFood').value='';buildFoodList();render();};}
function buildDessertList(){const wrap=$('#dessertList');wrap.innerHTML='';const ds=load(LS.desserts,[]);ds.forEach((d,idx)=>{const row=document.createElement('div');row.className='item';row.innerHTML=`<input class="btn" value="${escapeHtml(d)}"/><div style="display:flex;gap:8px"><button class="btn" data-notes>üìù Notes</button><button class="btn-warn" data-rm>Remove</button></div>`;wrap.appendChild(row);row.querySelector('[data-notes]').onclick=()=>openNotesEditor(d);row.querySelector('input').oninput=e=>{ds[idx]=e.target.value;save(LS.desserts,ds);render();};row.querySelector('[data-rm]').onclick=()=>{ds.splice(idx,1);save(LS.desserts,ds);buildDessertList();render();};});$('#addDessert').onclick=()=>{const v=($('#newDessert').value||'').trim();if(!v)return;const list=load(LS.desserts,[]);list.push(v);save(LS.desserts,list);$('#newDessert').value='';buildDessertList();render();};}
function show(m){m.style.display='flex';m.setAttribute('aria-hidden','false')}
function hide(m){m.style.display='none';m.setAttribute('aria-hidden','true')}

/* ---------- Day Notes modal ---------- */
const dayNotesModal = $('#dayNotesModal');
$('#dayNotesClose').onclick = ()=> hide(dayNotesModal);
$('#dayNotesDone').onclick  = ()=> hide(dayNotesModal);

function openDayNotes(day){
  const mISO=thisMondayISO();
  const plan=loadWeekPlan(mISO);
  const x=plan.days[day];
  const items = [
    {label:x.kids.main, role:'Kids main'},
    {label:x.kids.side, role:'Kids side'},
    {label:x.parents.main, role:'Parents main'},
    {label:x.parents.side, role:'Parents side'},
    ...(x.dessert?[{label:x.dessert, role:'Dessert'}]:[])
  ].filter(it=>it.label);

  const body = $('#dayNotesBody');
  body.innerHTML = items.length ? '' : '<div class="smallmuted">No items selected yet for this day.</div>';

  const notes = getNotes();
  items.forEach(it=>{
    const has = !!(notes[it.label] && (notes[it.label].global||'').trim());
    const row = document.createElement('div');
    row.className='noteRow';
    row.innerHTML = `
      <div><div style="font-weight:700">${escapeHtml(it.label)}</div><div class="smallmuted">${it.role}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        ${has?'<span class="badge">has notes</span>':''}
        <button class="btn" data-edit>Edit</button>
      </div>`;
    row.querySelector('[data-edit]').onclick = ()=> openNotesEditor(it.label, ()=>{ openDayNotes(day); updateNotesBadgesFor(day); });
    body.appendChild(row);
  });

  $('#dayNotesTitle').textContent = `Food Notes ¬∑ ${day}`;
  show(dayNotesModal);
}

function dayHasAnyNotes(dayData){
  const n=getNotes();
  return [dayData?.kids?.main, dayData?.kids?.side, dayData?.parents?.main, dayData?.parents?.side, dayData?.dessert]
    .filter(Boolean).some(lab => !!(n[lab] && (n[lab].global||'').trim()));
}
function updateNotesBadgesFor(day){
  const mISO=thisMondayISO(); const plan=loadWeekPlan(mISO); const data=plan.days[day];
  const btn = document.querySelector(`[data-notes="${day}"]`);
  if (btn) btn.setAttribute('data-hasnotes', String( dayHasAnyNotes(data) ));
}

/* ---------- Notes editor (global only) ---------- */
const notesEditModal = $('#notesEditModal');
$('#notesEditClose').onclick = ()=> hide(notesEditModal);
$('#fnSave').onclick = saveNotesFromEditor;
$('#fnClear').onclick = ()=>{
  if (!confirm('Clear notes for this item?')) return;
  const map=getNotes(); delete map[_editingLabel]; setNotes(map); hide(notesEditModal);
  if (notesEditModal._onSavedCb) notesEditModal._onSavedCb();
};

let _editingLabel = '';
function openNotesEditor(label, onSaved){
  _editingLabel = label;
  $('#fnLabel').textContent = label;

  const map = getNotes();
  const entry = map[label] || { global:'' };
  $('#fnGlobal').value = entry.global || '';

  notesEditModal._onSavedCb = onSaved || null;
  show(notesEditModal);
}
function saveNotesFromEditor(){
  const label = _editingLabel;
  const g = ($('#fnGlobal').value||'').trim();
  const map = getNotes();
  if (!g) { delete map[label]; } else { map[label] = { global:g }; }
  setNotes(map);
  hide(notesEditModal);
  if (notesEditModal._onSavedCb) notesEditModal._onSavedCb();
}

/* ---------- Templates / Groceries / Share ---------- */
const tplModal=$('#tplModal');$('#tplClose').onclick=()=>hide(tplModal);$('#tplApplyDone').onclick=()=>hide(tplModal);$('#btnTemplates').onclick=()=>openTemplates();
$('#tplSave').onclick=()=>{const name=($('#tplName').value||'').trim();if(!name)return alert('Name your template');const plan=loadWeekPlan(thisMondayISO());const t=load(LS.templates,[]);t.push({id:uid(),name,plan});save(LS.templates,t);$('#tplName').value='';buildTplLists();}
function openTemplates(){buildTplLists();show(tplModal)}
function buildTplLists(){const built=$('#tplBuiltins');built.innerHTML='';const pizza=document.createElement('div');pizza.className='item';pizza.innerHTML=`<div>üçï Pizza Friday</div><button class="btn" data-apply>Apply</button>`;pizza.querySelector('[data-apply]').onclick=()=>{applyPizzaFriday();};built.appendChild(pizza);const wrap=$('#tplUser');wrap.innerHTML='';const tpls=load(LS.templates,[]);if(!tpls.length){const empty=document.createElement('div');empty.className='item';empty.innerHTML='<div>No saved templates yet.</div>';wrap.appendChild(empty);}else{tpls.forEach(t=>{const row=document.createElement('div');row.className='item';row.innerHTML=`<div>${escapeHtml(t.name)}</div><div style="display:flex;gap:8px"><button class="btn" data-apply>Apply</button><button class="btn-warn" data-del>Delete</button></div>`;wrap.appendChild(row);row.querySelector('[data-apply]').onclick=()=>{save(LS.week(thisMondayISO()),t.plan);render();};row.querySelector('[data-del]').onclick=()=>{const arr=load(LS.templates,[]).filter(x=>x!==t);save(LS.templates,arr);buildTplLists();};});}}
function applyPizzaFriday(){const plan=loadWeekPlan(thisMondayISO());plan.days["Fri"].kids.main="üçï Pizza";plan.days["Fri"].parents.main="üçï Pizza";saveWeekPlan(thisMondayISO(),plan);render();}
$('#btnPizzaFri').onclick=()=>{const now=!load(LS.pizzaFri,false);save(LS.pizzaFri,now);$('#pizzaState').textContent=now?'on':'off';render();}

const groModal=$('#groModal');$('#groClose').onclick=()=>hide(groModal);
$('#btnGroceries').onclick=()=>openGroceries();
$('#groCopy').onclick=()=>navigator.clipboard.writeText(groceryText()).then(()=>alert('Grocery list copied.'));
$('#groDownload').onclick=()=>{const blob=new Blob([groceryText()],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Fambam-Groceries-${thisMondayISO()}.txt`;a.click();URL.revokeObjectURL(a.href);}

function openGroceries(){const pre=document.createElement('pre');pre.style.whiteSpace='pre-wrap';pre.style.margin='0';pre.textContent=groceryText();const body=$('#groBody');body.innerHTML='';body.appendChild(pre);show(groModal);}
function groceryText(){const plan=loadWeekPlan(thisMondayISO());const pantry=new Set(load(LS.pantry,[]).map(s=>s.toLowerCase()));const buckets={"Kids mains":{}, "Kids sides":{}, "Parents mains":{}, "Parents sides":{}, "Desserts":{}};const bump=(b,name)=>{if(!name)return;const clean=name.replace(/^[^\w]+/,'').trim();if(!clean)return;if(pantry.has(clean.toLowerCase()))return;buckets[b][clean]=(buckets[b][clean]||0)+1;};DAYS.forEach(d=>{const x=plan.days[d]||emptyDay();bump("Kids mains",x.kids.main);bump("Kids sides",x.kids.side);bump("Parents mains",x.parents.main);bump("Parents sides",x.parents.side);bump("Desserts",x.dessert);});const lines=[`üõí Fambam Groceries ‚Äî ${$('#weekLabel').textContent}`];for(const [section,items] of Object.entries(buckets)){const names=Object.keys(items).sort((a,b)=>a.localeCompare(b));if(!names.length)continue;lines.push(`\n${section}`);names.forEach(n=>lines.push(`- ${n}${items[n]>1?` √ó${items[n]}`:''}`));}if(pantry.size){lines.push(`\n(Excluded pantry: ${[...pantry].join(', ')})`);}return lines.join('\n');}
function planSummaryText(){const plan=loadWeekPlan(thisMondayISO());const lines=[`üçΩÔ∏è Fambam Dinner Plan ‚Äî ${$('#weekLabel').textContent}`];DAYS.forEach(d=>{const x=plan.days[d];const r=(x.rating==null)?'':(x.rating===1?' üëç':(x.rating===-1?' üëé':' üòê'));const kids=[x.kids.main,x.kids.side].filter(Boolean).join(' + ');const pars=[x.parents.main,x.parents.side].filter(Boolean).join(' + ');const des=x.dessert?` ‚Ä¢ Dessert: ${x.dessert}`:'';lines.push(`${d}: Kids ${kids||'‚Äî'} | Parents ${pars||'‚Äî'}${des}${r}`)});return lines.join('\n');}

/* Share dropdown */
const shareBtn = $('#btnShare'), shareDD = $('#shareDD');
shareBtn.onclick = (e)=>{ e.stopPropagation(); shareDD.classList.toggle('open'); };
document.addEventListener('click', ()=>shareDD.classList.remove('open'));
shareDD.addEventListener('click', (e)=>{
  const a = e.target.closest('.mi'); if(!a) return;
  shareDD.classList.remove('open');
  if (a.dataset.share==='gro') shareText(groceryText());
  else if (a.dataset.share==='plan') shareText(planSummaryText());
  else if (a.dataset.share==='copy') navigator.clipboard.writeText(planSummaryText()).then(()=>alert('Summary copied.'));
});

/* Reset/Copy/Admin (copy moved into Share menu) */
$('#btnReset').onclick=()=>{if(!confirm('Clear all entries for this week?'))return;const plan={days:{}};DAYS.forEach(d=>plan.days[d]=emptyDay());save(LS.week(thisMondayISO()),plan);render();}
$('#btnAdmin').onclick=()=>location.href='./index.html#admin';

/* PIN modal */
function requestPinUI(onSuccess){
  const m=$('#pinModal'),input=$('#pinInputModal'),ok=$('#pinOk'),x=$('#pinClose');
  function close(){m.style.display='none';m.setAttribute('aria-hidden','true');input.value='';ok.onclick=x.onclick=null;}
  function open(){m.style.display='flex';m.setAttribute('aria-hidden','false');setTimeout(()=>{input.focus();input.setSelectionRange(input.value.length,input.value.length);},50);}
  ok.onclick=()=>{const pin=input.value.trim();if(!/^\d{1,8}$/.test(pin))return alert('PIN must be 1‚Äì8 digits.'); if(Family.verifyPin(pin)){close(); onSuccess&&onSuccess();}else{alert('Incorrect PIN.');input.focus();input.select();}}
  x.onclick=close; m.onclick=e=>{if(e.target===m)close();}; document.addEventListener('keydown',function esc(ev){if(ev.key==='Escape'){close();document.removeEventListener('keydown',esc)}}); open();
}

/* ---------- Boot ---------- */
seedFoodsIfNeeded(); render();
if('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
  </script>
</body>
</html>
