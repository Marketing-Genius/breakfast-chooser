<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Dinner Planner</title>

<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px;
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#0f172a;
  -webkit-tap-highlight-color: transparent;
}

/* Header */
header{
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  background:#0b1224; border:1px solid #243043; border-radius:16px; padding:12px 14px;
  box-shadow: var(--shadow); margin:16px;
}
.title{display:flex; flex-direction:column;}
.title .big{font-weight:800; font-size:1.2rem}
.title .small{color:var(--muted); font-size:.9rem}
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.btn{font:inherit; color:#e5e7eb; background:#0b1224; border:1px solid #334155; border-radius:12px; padding:8px 12px; cursor:pointer}
.btn-ghost{background:transparent}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4); color:#001018; border:none; font-weight:800}
.icon{font-size:1.1rem}

/* Week row */
.weekRow{display:flex; gap:12px; align-items:center; padding:0 16px; margin-top:-6px}
.weekBadge{background:#0b1224; border:1px solid #334155; border-radius:10px; padding:6px 10px}

/* Day cards */
.container{max-width:1100px; margin:0 auto 40px; padding:0 16px; display:grid; gap:14px}
@media(min-width:900px){ .container{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
.card{
  background:rgba(31,41,55,.85); border:1px solid rgba(31,41,55,.9);
  border-radius:16px; padding:12px; box-shadow:var(--shadow)
}
.card header{ display:flex; justify-content:space-between; align-items:center; padding:8px 0 12px 0; background:transparent; border:0; margin:0 }
.card h3{ margin:0; font-size:1rem }
.row{ display:grid; grid-template-columns: 120px 1fr auto; gap:10px; align-items:center; margin:8px 0 }
.label{ color:var(--muted) }
.sel{ display:flex; gap:8px; align-items:center }
select{ width:100%; background:#0b1224; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px; font:inherit }
.noteBtn{ min-width:40px }
.badge{ display:inline-block; background:#0b1224; border:1px solid #334155; border-radius:10px; padding:4px 8px; font-size:.8rem; color:#cbd5e1 }

/* Modals */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);background:rgba(17,24,39,.98);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937}
.modal .body{padding:14px 16px;display:grid;gap:14px; max-height:70vh; overflow:auto}
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px}

/* Manage foods list */
.list{display:grid; gap:10px;}
.item{display:flex; align-items:center; gap:10px; background:#1f2937; border:1px solid #111827; border-radius:12px; padding:10px}
.item input{flex:1; background:#0b1224; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:8px 10px}
.item .rowBtns{display:flex; gap:8px}
.tabbar{display:flex; gap:8px; flex-wrap:wrap}
.tab{padding:8px 12px; border-radius:10px; background:#0b1224; border:1px solid #334155; cursor:pointer}
.tab[aria-selected="true"]{ outline:2px solid var(--accent) }
.tabpanel{ display:none }
.tabpanel[aria-hidden="false"]{ display:block }

/* Footer note */
footer{ text-align:center; color:#8fb7ff; opacity:.7; font-size:.85rem; padding:10px }
footer .v{ opacity:.6; font-size:.72rem }
</style>
</head>
<body>

<header>
  <div class="title">
    <div class="big">Dinner Planner</div>
    <div class="small">Plan dinners · templates · groceries</div>
  </div>
  <div class="controls">
    <a class="btn" href="./index.html">← Home</a>
    <span class="weekBadge" id="weekLabel">Week of …</span>
    <button id="btnPrev" class="btn btn-ghost">◀</button>
    <button id="btnNext" class="btn btn-ghost">▶</button>
    <button id="btnManage" class="btn">Manage</button>
    <button id="btnGroceries" class="btn">Copy Groceries</button>
  </div>
</header>

<div class="container" id="days"></div>

<footer>
  Works offline · data stays on this device
  <div class="v">Dinner v1.3 (Food Notes)</div>
</footer>

<!-- Manage Foods Modal -->
<div id="manageModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="manageTitle">
  <div class="modal">
    <header>
      <div id="manageTitle" style="font-weight:800">Manage Foods</div>
      <button class="btn" data-close>✖</button>
    </header>
    <div class="body">
      <div class="tabbar">
        <button class="tab" data-tab="kidsMain" aria-selected="true">Kids – Main</button>
        <button class="tab" data-tab="kidsSide">Kids – Side</button>
        <button class="tab" data-tab="parentMain">Parents – Main</button>
        <button class="tab" data-tab="parentSide">Parents – Side</button>
        <button class="tab" data-tab="desserts">Desserts</button>
      </div>

      <!-- Panels -->
      <section class="tabpanel" data-panel="kidsMain" aria-hidden="false">
        <div class="list" id="list-kidsMain"></div>
        <div class="item">
          <input id="add-kidsMain" placeholder="Add item"/>
          <div class="rowBtns">
            <button class="btn" data-add="kidsMain">Add</button>
          </div>
        </div>
      </section>

      <section class="tabpanel" data-panel="kidsSide" aria-hidden="true">
        <div class="list" id="list-kidsSide"></div>
        <div class="item">
          <input id="add-kidsSide" placeholder="Add item"/>
          <div class="rowBtns"><button class="btn" data-add="kidsSide">Add</button></div>
        </div>
      </section>

      <section class="tabpanel" data-panel="parentMain" aria-hidden="true">
        <div class="list" id="list-parentMain"></div>
        <div class="item">
          <input id="add-parentMain" placeholder="Add item"/>
          <div class="rowBtns"><button class="btn" data-add="parentMain">Add</button></div>
        </div>
      </section>

      <section class="tabpanel" data-panel="parentSide" aria-hidden="true">
        <div class="list" id="list-parentSide"></div>
        <div class="item">
          <input id="add-parentSide" placeholder="Add item"/>
          <div class="rowBtns"><button class="btn" data-add="parentSide">Add</button></div>
        </div>
      </section>

      <section class="tabpanel" data-panel="desserts" aria-hidden="true">
        <div class="list" id="list-desserts"></div>
        <div class="item">
          <input id="add-desserts" placeholder="Add dessert"/>
          <div class="rowBtns"><button class="btn" data-add="desserts">Add</button></div>
        </div>
      </section>
    </div>
    <div class="footer">
      <button class="btn-primary" data-close>Done</button>
    </div>
  </div>
</div>

<!-- Food Notes Modal (editor) -->
<div id="notesModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="notesTitle">
  <div class="modal">
    <header>
      <div id="notesTitle" style="font-weight:800">Food Notes</div>
      <button class="btn" data-close>✖</button>
    </header>
    <div class="body">
      <div class="badge">Item</div>
      <div id="fn-item" class="badge" style="font-weight:800"></div>

      <div class="badge">Global notes</div>
      <textarea id="fn-global" class="btn" style="min-height:80px"></textarea>

      <div class="badge">Kid-specific notes</div>
      <div id="fn-kids"></div>
    </div>
    <div class="footer">
      <button id="fn-save" class="btn-primary">Save</button>
    </div>
  </div>
</div>

<!-- Food Notes Modal (viewer) -->
<div id="notesView" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="notesViewTitle">
  <div class="modal" style="max-width:620px">
    <header>
      <div id="notesViewTitle" style="font-weight:800">Notes</div>
      <button class="btn" data-close>✖</button>
    </header>
    <div class="body" id="notesViewBody"></div>
    <div class="footer">
      <button class="btn-primary" data-close>Close</button>
    </div>
  </div>
</div>

<!-- Family store (if available) -->
<script src="family.js?v=3.3.6"></script>
<script>
/* ===== Utilities & Store ===== */
const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
const load = (k, f)=>{ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? f; }catch{ return f; } };
const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
const uid = ()=> Math.random().toString(36).slice(2,10);
const today = new Date();
function mondayOf(d){ const n=new Date(d); const day=(n.getDay()+6)%7; n.setDate(n.getDate()-day); n.setHours(0,0,0,0); return n; }
function fmtDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }
function weekKey(d){ const m = mondayOf(d); const y = m.getFullYear(); const w = Math.floor(( (m - new Date(y,0,1)) / 86400000 + ((new Date(y,0,1).getDay()+6)%7) ) / 7)+1; return `${y}-W${String(w).padStart(2,'0')}`; }

const K = {
  foods: {
    kidsMain: 'dp:foods:kidsMain',
    kidsSide: 'dp:foods:kidsSide',
    parentMain: 'dp:foods:parentMain',
    parentSide: 'dp:foods:parentSide',
    desserts: 'dp:foods:desserts',
  },
  planPrefix: 'dp:plan:week:',
  notes: 'dp:food:notes' // map: label -> {global, perKid:{kidId:text}}
};

// Seed defaults once
(function seed(){
  if (!localStorage.getItem(K.foods.kidsMain)) save(K.foods.kidsMain,
    ['🍝 Spaghetti','🍗 Chicken Nuggets','🌮 Tacos','🍕 Pizza','🥪 Sandwiches','🍛 Fried Rice','🥣 Mac & Cheese','🥟 Pot Stickers','🍲 Soup','🥚 Omelets']);
  if (!localStorage.getItem(K.foods.kidsSide)) save(K.foods.kidsSide,
    ['🥦 Veggies','🍎 Fruit','🥗 Salad','🍞 Bread','🧀 Cheese','🥔 Fries','🍚 Rice','🫘 Beans']);
  if (!localStorage.getItem(K.foods.parentMain)) save(K.foods.parentMain,
    ['🥩 Steak & Veg','🍣 Baked Fish','🍗 Roast Chicken','🥘 Curry','🍝 Pasta','🥗 Big Salad','🍔 Burgers','🌯 Fajitas']);
  if (!localStorage.getItem(K.foods.parentSide)) save(K.foods.parentSide,
    ['🥦 Veggies','🥗 Salad','🍞 Bread','🥔 Potatoes','🍚 Rice','🫘 Beans']);
  if (!localStorage.getItem(K.foods.desserts)) save(K.foods.desserts,
    ['🍨 Ice Cream','🍪 Cookies','🧁 Cupcakes','🍫 Chocolate','🍓 Berries','🍰 Cake']);
})();

/* ===== Week state ===== */
let currentMonday = mondayOf(today);
const weekLabel = document.getElementById('weekLabel');
function updateWeekLabel(){
  const end = new Date(currentMonday); end.setDate(end.getDate()+6);
  weekLabel.textContent = `Week of ${fmtDate(currentMonday)} – ${fmtDate(end)}`;
}
document.getElementById('btnPrev').onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); };
document.getElementById('btnNext').onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); };

/* ===== Plan storage ===== */
function loadPlan(){
  return load(K.planPrefix+weekKey(currentMonday), {
    days: Array.from({length:7},()=>({
      kids:{main:'',side:'',dessert:''},
      parents:{main:'',side:''}
    }))
  });
}
function savePlan(p){
  save(K.planPrefix+weekKey(currentMonday), p);
}

/* ===== Food Notes helpers ===== */
function getNotesMap(){ return load(K.notes, {}); }
function setNotesMap(m){ save(K.notes, m); }
function getKidList(){ return (window.Family && Family.getKids && Family.getKids()) || []; }

/* ===== UI: Manage modal ===== */
const manageModal = document.getElementById('manageModal');
function openManage(){ manageModal.style.display='flex'; buildManageLists(); }
function closeManage(){ manageModal.style.display='none'; }
$$('#manageModal [data-close]').forEach(b=> b.onclick = closeManage);

// Tabs
$$('#manageModal .tab').forEach(t=>{
  t.onclick = ()=>{
    $$(`#manageModal .tab`).forEach(x=>x.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    const key = t.dataset.tab;
    $$(`#manageModal .tabpanel`).forEach(p=>p.setAttribute('aria-hidden', String(p.dataset.panel!==key)));
  };
});

function buildManageLists(){
  ['kidsMain','kidsSide','parentMain','parentSide','desserts'].forEach(key=>{
    const listEl = document.getElementById('list-'+key);
    const arr = load(K.foods[key], []);
    listEl.innerHTML='';
    arr.forEach((label, idx)=>{
      const row = document.createElement('div');
      row.className='item';
      row.innerHTML = `
        <input value="${escapeHtml(label)}"/>
        <div class="rowBtns">
          <button class="btn" data-notes>📝 Notes</button>
          <button class="btn" data-up>▲</button>
          <button class="btn" data-down>▼</button>
          <button class="btn" data-del>Remove</button>
        </div>`;
      const input = row.querySelector('input');
      input.oninput = () => { arr[idx] = input.value; save(K.foods[key], arr); };
      row.querySelector('[data-del]').onclick = () => { arr.splice(idx,1); save(K.foods[key],arr); buildManageLists(); };
      row.querySelector('[data-up]').onclick = () => { if(idx>0){ const t=arr[idx-1]; arr[idx-1]=arr[idx]; arr[idx]=t; save(K.foods[key],arr); buildManageLists(); } };
      row.querySelector('[data-down]').onclick = () => { if(idx<arr.length-1){ const t=arr[idx+1]; arr[idx+1]=arr[idx]; arr[idx]=t; save(K.foods[key],arr); buildManageLists(); } };
      row.querySelector('[data-notes]').onclick = ()=> openNotesEditor(label, (newLabel)=>{
        // If label text changed in editor header we can remap notes (optional)
        if (newLabel && newLabel!==label){
          const notes = getNotesMap();
          if (notes[label] && !notes[newLabel]){ notes[newLabel] = notes[label]; delete notes[label]; setNotesMap(notes); }
        }
      });
      listEl.appendChild(row);
    });
    const addBtn = document.querySelector(`[data-add="${key}"]`);
    const addInp = document.getElementById('add-'+key);
    addBtn.onclick = ()=>{ const v=(addInp.value||'').trim(); if(!v) return; arr.push(v); save(K.foods[key],arr); addInp.value=''; buildManageLists(); };
  });
}

document.getElementById('btnManage').onclick = ()=>{
  // Optional PIN gate if Family PIN is set
  const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
  if (hasPin && window.Family && Family.verifyPin){
    const pin = prompt('Enter Admin PIN'); if (pin===null) return;
    if (!Family.verifyPin(pin)){ alert('Incorrect PIN'); return; }
  }
  openManage();
};

/* ===== UI: Notes editor ===== */
const notesModal = document.getElementById('notesModal');
const fnItem = document.getElementById('fn-item');
const fnGlobal = document.getElementById('fn-global');
const fnKidsWrap = document.getElementById('fn-kids');
document.querySelectorAll('#notesModal [data-close]').forEach(b=> b.onclick = ()=> notesModal.style.display='none');

function openNotesEditor(label, onSaveLabelChanged){
  const notes = getNotesMap();
  const entry = notes[label] || { global:'', perKid:{} };
  fnItem.textContent = label;
  fnGlobal.value = entry.global || '';
  fnKidsWrap.innerHTML = '';
  const kids = getKidList();
  kids.forEach(k=>{
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="badge" style="margin:8px 0 6px 0">${escapeHtml(k.name)}</div>
      <textarea class="btn" data-kid="${k.id}" style="width:100%;min-height:60px" placeholder="Notes for ${escapeHtml(k.name)}…"></textarea>`;
    wrap.querySelector('textarea').value = entry.perKid?.[k.id] || '';
    fnKidsWrap.appendChild(wrap);
  });
  notesModal.style.display='flex';

  document.getElementById('fn-save').onclick = ()=>{
    const n = getNotesMap();
    const perKid = {};
    $$(`#fn-kids textarea`).forEach(t=>{ const v=t.value.trim(); if(v) perKid[t.dataset.kid]=v; });
    n[label] = { global: fnGlobal.value.trim(), perKid };
    setNotesMap(n);
    if (onSaveLabelChanged) onSaveLabelChanged(fnItem.textContent);
    notesModal.style.display='none';
  };
}

/* ===== UI: Notes viewer ===== */
const notesView = document.getElementById('notesView');
const notesViewBody = document.getElementById('notesViewBody');
$$('#notesView [data-close]').forEach(b=> b.onclick = ()=> notesView.style.display='none');

function showNotes(label){
  const entry = getNotesMap()[label];
  if (!entry || (!entry.global && !Object.keys(entry.perKid||{}).length)){
    alert('No notes yet for this item.'); return;
  }
  notesViewBody.innerHTML = '';
  const sec = (title, text) => {
    const d=document.createElement('div');
    d.innerHTML = `<div class="badge" style="margin-top:6px">${title}</div><div class="btn" style="white-space:pre-wrap">${escapeHtml(text)}</div>`;
    notesViewBody.appendChild(d);
  };
  if (entry.global) sec('Global', entry.global);
  const kids = getKidList();
  kids.forEach(k=>{
    const v = entry.perKid?.[k.id];
    if (v) sec(k.name, v);
  });
  document.getElementById('notesViewTitle').textContent = `Notes · ${label}`;
  notesView.style.display='flex';
}

/* ===== Render week ===== */
const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
function renderWeek(){
  updateWeekLabel();
  const root = document.getElementById('days'); root.innerHTML='';
  const plan = loadPlan();
  for (let i=0;i<7;i++){
    const d = new Date(currentMonday); d.setDate(d.getDate()+i);
    const p = plan.days[i];

    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <header>
        <h3>${dayNames[i]}, ${fmtDate(d)}</h3>
        ${i===4 ? '<span class="badge">🍕 Pizza Night</span>' : ''}
      </header>

      <div class="row">
        <div class="label">Kids</div>
        <div class="sel">
          <select data-k="kids.main"></select>
          <button class="btn noteBtn" title="Notes" data-info="kids.main">ℹ️</button>
          <select data-k="kids.side"></select>
          <button class="btn noteBtn" title="Notes" data-info="kids.side">ℹ️</button>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div class="label">Parents</div>
        <div class="sel">
          <select data-k="parents.main"></select>
          <button class="btn noteBtn" title="Notes" data-info="parents.main">ℹ️</button>
          <select data-k="parents.side"></select>
          <button class="btn noteBtn" title="Notes" data-info="parents.side">ℹ️</button>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div class="label">Dessert</div>
        <div class="sel">
          <select data-k="kids.dessert"></select>
          <button class="btn noteBtn" title="Notes" data-info="kids.dessert">ℹ️</button>
        </div>
        <div></div>
      </div>
    `;
    root.appendChild(el);

    // Populate selects
    const fill = (sel, items, value)=> {
      sel.innerHTML = `<option value="">Choose item…</option>` + items.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
      sel.value = value || '';
    };
    const foods = {
      'kids.main': load(K.foods.kidsMain, []),
      'kids.side': load(K.foods.kidsSide, []),
      'parents.main': load(K.foods.parentMain, []),
      'parents.side': load(K.foods.parentSide, []),
      'kids.dessert': load(K.foods.desserts, [])
    };
    $$('select', el).forEach(sel=>{
      const key = sel.dataset.k;
      fill(sel, foods[key], getByPath(p, key));
      sel.onchange = ()=>{ setByPath(p, key, sel.value); savePlan(plan); };
    });

    // Notes viewers
    $$('[data-info]', el).forEach(btn=>{
      btn.onclick = ()=>{
        const sel = btn.previousElementSibling && btn.previousElementSibling.tagName==='SELECT'
          ? btn.previousElementSibling : btn.parentElement.querySelector('select');
        const label = sel && sel.value;
        if (!label) { alert('No item selected.'); return; }
        showNotes(label);
      };
    });

    // Friday pizza autofill for convenience (does not overwrite if already set)
    if (i===4 && !p.kids.main) { p.kids.main = '🍕 Pizza'; savePlan(plan); $$('select[data-k="kids.main"]', el)[0].value = p.kids.main; }
  }
}
function getByPath(obj, path){
  return path.split('.').reduce((o,k)=> o&&o[k], obj);
}
function setByPath(obj, path, val){
  const ks = path.split('.'); const last = ks.pop();
  const tgt = ks.reduce((o,k)=> (o[k] ??= {}), obj);
  tgt[last] = val;
}

/* ===== Manage button & groceries ===== */
document.getElementById('btnGroceries').onclick = ()=>{
  const p = loadPlan();
  const items = [];
  p.days.forEach(day=>{
    if (day.kids.main) items.push(day.kids.main);
    if (day.kids.side) items.push(day.kids.side);
    if (day.parents.main) items.push(day.parents.main);
    if (day.parents.side) items.push(day.parents.side);
    if (day.kids.dessert) items.push(day.kids.dessert);
  });
  const text = [...new Set(items)].join('\n');
  try{
    navigator.clipboard.writeText(text);
    alert('Grocery list copied to clipboard.');
  }catch{
    alert(text || 'No items picked yet.');
  }
};

/* ===== Wire up manage open ===== */
document.getElementById('btnManage').addEventListener('click', ()=>{});

/* ===== Start ===== */
updateWeekLabel();
renderWeek();

/* ===== Helpers ===== */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]).replace('&','&amp;')) }
</script>
</body>
</html>
